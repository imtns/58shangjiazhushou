<template>
    <view class="notice-container">
        <view class="follow-public">
            <text>关注公众号接收通知</text>
            <!-- <navigator class="follow-action" url="/pages/followPublic">马上关注</navigator> -->
            <button class="follow-action" wx:if="{{canIUse}}" open-type="getUserInfo" @tap="loadSession()">马上关注</button>
            <cropper></cropper>
        </view>
        <view class="notice-header">
            <view>全部通知</view>
            <view class="clear-notice attach-notice" bindtap="clearAll">清空</view>
        </view>
        <view class="notice-new">
            <navigator class="notice-name notice-order" url="orderNoticeList" hover-class="none">订单提醒<view class="num" wx:if="{{orderUnRead > 0}}">{{orderUnRead}}</view></navigator>
            <navigator class="notice-name notice-account" url="accountNoticeList" hover-class="none">入账通知<view class="num" wx:if="{{recivMoneyUnRead > 0}}">{{recivMoneyUnRead}}</view></navigator>
        </view>
        <scroll-view class="notice-list" wx:if="{{noticeList.length>0}}" scroll-y="true" scroll-with-animation="true" lower-threshold="50" bindscrolltolower="noticeListMore">
        <block wx:for="{{noticeList}}" wx:key="index">
            <view class="notice-list-item">
                <view class="notice-item" bindtap="touploadInfo" data-item="{{item}}">
                    <view class="notice-img {{item.status === 1 ? 'new-msg' : ''}}">
                        <image src="{{item.mpLogo || 'https://pic8.58cdn.com.cn/bizmp/n_v285d6a16d725a446694db35df23c9db24.png?w=120&h=120'}}"></image>
                    </view>
                    <view class="notice-content">
                        <view class="notice-detail">
                            <view class="notice-name">
                                <view class="notice-weixin-type {{item.app_type === 1 ? 'youxiang' : ''}}">{{item.app_type === 1 ? '优享' : '微信'}}</view>
                                <view class="notice-weixin-name">{{item.mpName}}</view>
                            </view>
                            <view class="notice-msg">{{item.content}}</view>
                        </view>
                        <view class="notice-state">
                            <view class="notice-status">{{item.title}}</view>
                            <view class="notice-time">{{item.createTime}}</view>
                        </view>
                    </view>
                </view>
            </view>
        </block>
        </scroll-view>
    </view>
</template>

<script>
import wepy from 'wepy';
import { sleep, toast } from '../utils/index';

import { get } from '../utils/ajax';

export default class NoticeList extends wepy.page {
    config = {
        navigationBarTitleText: '通知',
        disableScroll: true,
    }
    data = {
        noticeList: [],
        orderUnRead: 0,
        recivMoneyUnRead: 0,
        code: '',
        iv: '',
        encryptedData: '',
        session: '',
        canIUse: wx.canIUse('button.open-type.getUserInfo'),
        unreadcount: 0,
        sendParams: {
            group: 1,
            page: 1,
            pageSize: 10,
        },
    }
    methods = {
        noticeListMore() {
            this.sendParams.page = this.sendParams.page + 1;
            this.sendParams = Object.assign({}, this.sendParams, this.sendParams.page);
            this.loadNoticeList();
        },
        async loadSession() {
            try {
                console.log(this.code);
                const { data } = await get('/wechat/bizAssistAuth/session', { code: this.code });
                console.log(data);
                const { sessionKey } = data;
                const { state } = await get('/wechat/bizAssistAuth/insert', { encryptedData: this.encryptedData, iv: this.iv, session: sessionKey });
                if (state === 100) {
                    wx.navigateTo = '/pages/followPublic';
                }
            } catch (e) {
                console.log(e);
            }
        },
    }
    async onShow() {
        const that = this;
        that.loadList();
        that.loadCode();
        that.getInfo();
    }
    async onHide() {
        console.log('onHide');
    }
    async onUnload() {
        console.log('onUnLoad');
        if (this.unreadcount <= 0) {
            return;
        }
        try {
            await get('/mplogic/readgroupmsg', { group: 1 });
        } catch (e) {
            console.log(e);
        }
    }
    async loadCode() {
        const that = this;
        wx.login({
            success(res) {
                if (res.code) {
                    console.log(res.code);
                    that.code = res.code;
                    // 查看是否授权
                } else {
                    console.log('denglishiba');
                }
            },
        });
    }
    async getInfo() {
        const that = this;
        // 已经授权，可以调用getuseinfo获取头像昵称
        wx.getUserInfo({
            success(res) {
                console.log(res);
                const { iv, encryptedData } = res;
                that.iv = iv;
                that.encryptedData = encryptedData;
                // console.log(ress.userInfo);
            },
        });
    }
    async loadList() {
        try {
            const { data } = await get('/mplogic/msglist');
            const {
                msglist, unreadcount, orderUnRead, recivMoneyUnRead,
            } = data;
            this.unreadcount = unreadcount;
            this.orderUnRead = orderUnRead;
            this.recivMoneyUnRead = recivMoneyUnRead;
            if (msglist && msglist.length > 0) {
                const arr = [];
                msglist.forEach((item) => {
                    const ele = item;
                    if (ele.mpLogo && ele.mpLogo.indexOf('http') === -1) {
                        ele.mpLogo = `https://pic1.58cdn.com.cn${ele.mpLogo}`;
                    }
                    arr.push(ele);
                });
                this.noticeList = arr;
            } else {
                this.noticeList = [];
            }
            this.$apply();
        } catch (e) {
            console.log(e);
        }
    }
    async loadNoticeList() {
        try {
            const { data } = await get('/mplogic/getgroupmsglist', this.sendParams);
            const { msglist } = data;
            if (msglist.length === 0) {
                this.accountList = this.accountList;
                toast('没有更多消息啦');
                return;
            }
            const arr = [];
            msglist.forEach((item) => {
                const { content } = item;
                const ele = Object.assign(
                    {},
                    item, { content: JSON.parse(content) },
                );
                if (ele.mpLogo && ele.mpLogo.indexOf('http') === -1) {
                    ele.mpLogo = `https://pic1.58cdn.com.cn${ele.mpLogo}`;
                }
                arr.push(ele);
            });
            this.noticeList = this.noticeList.concat(arr);
            this.$apply();
        } catch (e) {
            console.log(e);
        }
    }
    touploadInfo(e) {
        const { item } = e.currentTarget.dataset;
        // 微信小程序，审核失败，进 上传素材页面
        if (item.msgType !== 5 && item.app_type !== 1) return;
        wepy.navigateTo({
            url: '../uploadInfo',
        });
    }
    async clearAll() {
        try {
            if (this.noticeList.length <= 0) {
                toast('没有消息，无需清空~');
                return;
            }
            await get('/mplogic/cleargroupmsg', { group: 1 });
            sleep();
            this.loadList();
        } catch (e) {
            console.log(e);
        }
    }
}
</script>

<style lang="scss">
page{
    width:100%;
    height:100%;
    background:#f5f5f5;
}
view,scroll-view{
    box-sizing:border-box;
}
.notice-container{
    width:100%;
    height:100%;
    .follow-public {
        width: 100%;
        height: 80rpx;
        line-height:80rpx;
        position:relative;
        font-size: 28rpx;
        color: #fd867e;
        padding: 0 30rpx;
        background-color: #ffecec;
        .follow-action {
            color: #fd867e;
            text-align: center;
            line-height: 50rpx;
            font-size: 28rpx;
            height: 50rpx;
            border: 1rpx solid #fd867e;
            border-radius: 5rpx;
            position:absolute;
            right:30rpx;
            top:15rpx;
        }
    }
    .notice-header{
        width:100%;
        padding:0 30rpx;
        height: 80rpx;
        line-height: 80rpx;
        position: relative;
        // top: 80rpx;
        // left: 0;
        // z-index:9;
        background:#f5f5f5;
        view{
            font-size: 28rpx;
            color: #999999;
            letter-spacing: 0;
        }
        .attach-notice{
            position:absolute;
            right:30rpx;
            top:0;
        }
        .clear-notice::before{
            position:absolute;
            left:-40rpx;
            top:22rpx;
            content:'';
            width:36rpx;
            height:36rpx;
            background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAYAAAGWB6gOAAAAAXNSR0IArs4c6QAAA2ZJREFUWAntWD2PGjEQXSAFDUiQiJa/cCU/IFFEvgqkdCeSjqPI7wFEdUmDdF0iILqGEiVKQ3EXGlCgOOlQBEgoShEEmWd2LNtrdvcWohSJJdae8Zu3Mx57vMJxLC0GXa1W2/JctVoVOqHcug2TcRdxzkj09/Agk9fUvcLY2jwvEQpwA97pdCS5MJ9Opzvier0uFOl0OrtzikRStsnyiZhRHtJx6BCR2YbDoXgfBwLcTzzU1uv1hChB8Xj8pQq481g6rq4ys7DT8nU8ofYU8SlkCTo7O3Py+bz8QaZoHwIkMoIB2mQy2Q3cJwVzgaFkWq/XGgBCpVJpo5eg0WgE2b+128iK3thC+kSZPado1J2yYFCoHskPBfwjINuu0iPeSbe3t1vCfmYn5EqyQu0pJCGaPZTj8djhnEH2JQJgX0MKN5uNSD4wHqJYLPZlNpvts5f61WqF8/6NFR4iWoELuH1wazQaD5rN5sa2wKxbLBZbWrfNwS/7+wRhdrYsJeyuraTwnNpTdjtUJJ6quqOMNY8ohFPKzLuwzFz8gJclwjV+UyqVnFwuF8jFx4aB2oYkb77SHuE5p9vtirHZS4Ay0IjoEF6pRFxYzV6xl0ONiLTX8/lcTt5loBHRadY8ikyE04xTHdTcq0K7MTWPggh4HuHThrxiGX0kIiSEMnwcInLiWvXIMw5T/HEJUt3SzpknNIp9u1wuPS9QFTc3N/hW+aTqzCPipFKp+61WC5dzRgUa47eU4e+G7r/ovwJIdtji6sek1UcbEGWf9rDna9aGDaujDdamav/MhvfsRhOEq4J0R7jAJfOYAvwoJWPgu0K0Opdk/KhQKDgnJyeGaTRxMBg4/X4fJeiSVumxyRK0Qr9gkM1mTbvIciYjT6/3Y5xYgxwSZct2p+BqVK/HIJkjULisJdHXIS7I6m3JxFF75mJuk8fXoUQiIW4IJjGNo8jMxdwmh69DyWRyb8pMorAyp4y5TTtfh8rl8g8ymOCGD/MlYJKbMjjcr4WJy21CAjc1DMQq8VJ7GO6gUDisGxpUvisEANULsY94qaGL2piDOW08nuveBPFpUKITEPwzoLYgGVjmYE7VnseBDhHQmrJiscgcog+SAWKHaLg3Zb5Xh3gTPajovaeonrN8SE/p+kBXxotDOP5t29/lY/k82n3mRQAAAABJRU5ErkJggg==);
            background-size: 36rpx 36rpx;
        }
    }
    .notice-new{
        width:100%;
        // position: fixed;
        // top: 160rpx;
        // left: 0;
        // z-index:9;
        .notice-name{
            display:block;
            font-size: 28rpx;
            color:#333;
            width: 100%;
            height: 88rpx;
            padding:0 30rpx;
            line-height: 88rpx;
            background: #fff;
            border-bottom: 1rpx solid #F3F3F3;
            box-sizing: border-box;
            position: relative;
            &:after{
                content:'';
                display:block;
                width:15rpx;
                height:26rpx;
                background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/arrow-right.png) no-repeat;
                background-size: 100% 100%;
                position: absolute;
                top: 31rpx;
                right: 30rpx;
            }
        }
        .num{
            font-size: 20rpx;
            color:#fff;
            width:34rpx;
            line-height: 34rpx;
            text-align:center;
            background:#FF552E;
            border-radius:100%;
            margin:27rpx 5rpx 0 0;
            float:right;
            margin-right:45rpx;
        }
    }
    .notice-list{
        width:100%;
        height:900rpx;
        // margin-top:335rpx;
        // position: absolute;
        // top:0;
        // bottom: 0;
        // left: 0;
        // right:0;
        .notice-list-item{
            padding:0 30rpx;
            background:#fff;
        }
        .notice-item{
            width:100%;
            padding:30rpx 0 30rpx 150rpx;
            border-bottom:1rpx solid #f3f3f3;
            position:relative;
            .notice-img{
                width:120rpx;
                height:120rpx;
                position:absolute;
                left:0;
                top:30rpx;
                image{
                    width:100%;
                    height:100%;
                }
            }
            .notice-img.new-msg::after{
                width:20rpx;
                height:20rpx;
                background:red;
                border-radius:50%;
                content:'';
                position:absolute;
                right:-9rpx;top:-8rpx;
            }
            .notice-content{
                display:flex;
                .notice-detail{
                    flex:1;
                    margin-right:10rpx;
                    .notice-name{
                        line-height:45rpx;
                        height:45rpx;
                        display:flex;
                    }
                    .notice-weixin-type{
                        width:62rpx;
                        height:36rpx;
                        line-height:36rpx;
                        text-align:center;
                        background: rgba(32,133,255,0.10);
                        border-radius: 8rpx;
                        font-size: 24rpx;
                        color: #2085FF;
                        letter-spacing: 0.52rpx;
                        margin:6rpx 8rpx 0 0;
                    }
                    .notice-weixin-type.youxiang{
                        color: #FFA100;
                        background: rgba(255,161,0,0.10);
                    }
                    .notice-weixin-name,.notice-msg{
                        height:45rpx;
                        font-size: 32rpx;
                        color: #333333;
                        letter-spacing: 0.48rpx;
                        line-height:45rpx;
                        width:278rpx;
                        overflow:hidden;
                        white-space:nowrap;
                        text-overflow:ellipsis;
                    }
                    .notice-msg{
                        height:48rpx;
                        height:48rpx;
                        font-size: 24rpx;
                        color: #999999;
                        letter-spacing: 0;
                        margin-top:42rpx;
                        width:350rpx;
                    }
                }
                .notice-state{
                    width:300rpx;
                    .notice-status{
                        font-size: 28rpx;
                        color: #333333;
                        letter-spacing: 0;
                        height:45rpx;
                        line-height:45rpx;
                        text-align: right;
                    }
                    .notice-time{
                        font-size: 24rpx;
                        color: #CCCCCC;
                        letter-spacing: 0;
                        margin-top:55rpx;
                        text-align: right;
                    }
                }
            }
        }
    }
    .emptyBox{
        width:100%;
        height:50%;
        text-align:center;
        margin: auto;
        .emptyIcon{
            width:209rpx;
            height:187rpx;
        }
        .emptyText{
            margin-top: 20rpx;
            color:#999999;
            font-size:30rpx;
        }
    }
}
</style>

<!-- 
# 时间格式化
# 标识优选个微信小程序的状态没有
-->