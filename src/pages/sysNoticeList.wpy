<template>
    <view class="notice-container">
        <navigator class="notice-visitor"
            hover-class="none"
            target="miniProgram"
            open-type="navigate"
            app-id="wx49b3af93cbcd737b"
            url=""
            path=""
            version="release">
            更多帖子访客消息
            <text class="browse-btn">去浏览 ></text>
        </navigator>
        <view class="notice-header">
            <view>全部通知</view>
            <view class="clear-notice attach-notice" bindtap="clearAll">清空</view>
        </view>
        <scroll-view class="notice-list" wx:if="{{sysList.length>0}}" scroll-y="true" scroll-with-animation="true" lower-threshold="50" bindscrolltolower="sysListMore" style="height: 100vh">  
            <block wx:for="{{sysList}}" wx:key="index">
                <view class="notice-list-item">
                    <view class="notice-item" bindtap="touploadInfo" data-item="{{item}}">
                        <view class="notice-img {{item.status === 1 ? 'new-msg' : ''}}">
                            <image src="{{item.mpLogo || 'https://pic8.58cdn.com.cn/bizmp/n_v285d6a16d725a446694db35df23c9db24.png?w=120&h=120'}}"></image>
                        </view>
                        <view class="notice-content">
                            <view class="notice-name">
                                <view class="notice-weixin-type {{item.app_type === 1 ? 'youxiang' : ''}}">{{item.app_type === 1 ? '优享' : '微信'}}</view>
                                <view class="notice-weixin-name">{{item.mpName}}</view>
                                <view class="notice-status">{{item.title}}</view>
                            </view>
                            <view class="notice-more">
                                <view class="notice-msg">{{item.content}}</view>
                                <view class="notice-time">{{item.createTime}}</view>
                            </view>
                        </view>
                    </view>
                </view>
            </block>
        </scroll-view> 
        <view class="emptyBox" wx:if="{{sysList.length<=0}}">
            <image src="https://static.58.com/lbg/shangjiaxcxht/zhushou/img/empty.png" class="emptyIcon"></image>
            <view class="emptyText">暂无通知</view>
        </view>
    </view>
</template>

<script>
import wepy from 'wepy';

import { sleep, toast } from '../utils/index';

import { get } from '../utils/ajax';

export default class SysNoticeList extends wepy.page {
    config = {
        navigationBarTitleText: '系统通知',
        // disableScroll: true,
    }
    data = {
        sysList: [],
        sendParams: {
            group: 2,
            pageNum: 1,
            pageSize: 10,
        },
    }
    methods = {
        sysListMore () {
            this.sendParams = Object.assign({}, this.sendParams, this.sendParams.pageNum + 1);
            this.loadList();
        },
    }
    onReady () {
        this.loadList();
    }
    async onLoad () {
        await sleep();
        console.log('onLoad');
    }
    async onHide () {
        console.log('onHide');
    }
    async onUnload () {
        console.log('onUnLoad');
        // if (this.unreadcount <= 0) {
        //     return;
        // }
        try {
            await get('/mplogic/readgroupmsg', { group: 1 });
        } catch (e) {
            console.log(e);
        }
    }
    async loadList() {
        try {
            const { data } = await get('/mplogic/msglist');
            const { msglist } = data;
            if (msglist.length === 0) {
                this.sysList = this.sysList;
                toast('没有更多系统通知啦');
                return;
            }
            const arr = [];
            msglist.forEach((item) => {
                const ele = item;
                if (ele.mpLogo && ele.mpLogo.indexOf('http') === -1) {
                    ele.mpLogo = `https://pic1.58cdn.com.cn${ele.mpLogo}`;
                }
                arr.push(ele);
            });
            this.sysList = this.sysList.concat(arr);
            this.$apply();
        } catch (e) {
            console.log(e);
        }
    }
    async clearAll() {
        try {
            if (this.sysList.length <= 0) {
                toast('没有消息，无需清空~');
                return;
            }
            const { state } = await get('/mplogic/cleargroupmsg', { group: 1 });
            if (state === 100) {
                sleep();
                this.sysList = [];
                wx.redirectTo({
                    url: 'sysNoticeList',
                });
            }
        } catch (e) {
            console.log(e);
        }
    }
}
</script>

<style lang="scss">
page {
    width: 100%;
    height: 100%;
    background: #f5f5f5;
}
view,
scroll-view {
    box-sizing: border-box;
}
.notice-visitor{
    font-size: 24rpx;
    color: #D38658;
    background: #FFF9DF;
    line-height: 56rpx;
    padding: 0 30rpx;
    position: fixed;
    width:100%;
    top: 0;
    left: 0;
    z-index: 9;
    &:before{
        display: inline-block;
        content: '';
        width: 35rpx;
        height: 35rpx;
        background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/sysnotice-icon.png) no-repeat;
        background-size: 100% 100%;
        margin: 11rpx 15rpx 0 0;
        float: left;
    }
    box-sizing: border-box;
    .browse-btn{
        float: right;
    }
}
.notice-header{
    width:100%;
    padding:0 30rpx;
    height: 80rpx;
    line-height: 80rpx;
    position: fixed;
    background:#f5f5f5;
    top: 56rpx;
    left: 0;
    z-index: 9;
    view{
        font-size: 28rpx;
        color: #999999;
        letter-spacing: 0;
    }
    .attach-notice{
        position:absolute;
        right:30rpx;
        top:0;
    }
    .clear-notice::before{
        position:absolute;
        left:-40rpx;
        top:22rpx;
        content:'';
        width:36rpx;
        height:36rpx;
        background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAYAAAGWB6gOAAAAAXNSR0IArs4c6QAAA2ZJREFUWAntWD2PGjEQXSAFDUiQiJa/cCU/IFFEvgqkdCeSjqPI7wFEdUmDdF0iILqGEiVKQ3EXGlCgOOlQBEgoShEEmWd2LNtrdvcWohSJJdae8Zu3Mx57vMJxLC0GXa1W2/JctVoVOqHcug2TcRdxzkj09/Agk9fUvcLY2jwvEQpwA97pdCS5MJ9Opzvier0uFOl0OrtzikRStsnyiZhRHtJx6BCR2YbDoXgfBwLcTzzU1uv1hChB8Xj8pQq481g6rq4ys7DT8nU8ofYU8SlkCTo7O3Py+bz8QaZoHwIkMoIB2mQy2Q3cJwVzgaFkWq/XGgBCpVJpo5eg0WgE2b+128iK3thC+kSZPado1J2yYFCoHskPBfwjINuu0iPeSbe3t1vCfmYn5EqyQu0pJCGaPZTj8djhnEH2JQJgX0MKN5uNSD4wHqJYLPZlNpvts5f61WqF8/6NFR4iWoELuH1wazQaD5rN5sa2wKxbLBZbWrfNwS/7+wRhdrYsJeyuraTwnNpTdjtUJJ6quqOMNY8ohFPKzLuwzFz8gJclwjV+UyqVnFwuF8jFx4aB2oYkb77SHuE5p9vtirHZS4Ay0IjoEF6pRFxYzV6xl0ONiLTX8/lcTt5loBHRadY8ikyE04xTHdTcq0K7MTWPggh4HuHThrxiGX0kIiSEMnwcInLiWvXIMw5T/HEJUt3SzpknNIp9u1wuPS9QFTc3N/hW+aTqzCPipFKp+61WC5dzRgUa47eU4e+G7r/ovwJIdtji6sek1UcbEGWf9rDna9aGDaujDdamav/MhvfsRhOEq4J0R7jAJfOYAvwoJWPgu0K0Opdk/KhQKDgnJyeGaTRxMBg4/X4fJeiSVumxyRK0Qr9gkM1mTbvIciYjT6/3Y5xYgxwSZct2p+BqVK/HIJkjULisJdHXIS7I6m3JxFF75mJuk8fXoUQiIW4IJjGNo8jMxdwmh69DyWRyb8pMorAyp4y5TTtfh8rl8g8ymOCGD/MlYJKbMjjcr4WJy21CAjc1DMQq8VJ7GO6gUDisGxpUvisEANULsY94qaGL2piDOW08nuveBPFpUKITEPwzoLYgGVjmYE7VnseBDhHQmrJiscgcog+SAWKHaLg3Zb5Xh3gTPajovaeonrN8SE/p+kBXxotDOP5t29/lY/k82n3mRQAAAABJRU5ErkJggg==);
        background-size: 36rpx 36rpx;
    }
}
.notice-list{
    width:100%;
    margin-top: 136rpx;
    .notice-list-item{
        padding:0 30rpx;
        background:#fff;
    }
    .notice-item{
        width:100%;
        padding:30rpx 0 30rpx 150rpx;
        border-bottom:1rpx solid #f3f3f3;
        position:relative;
        .notice-img{
            width:120rpx;
            height:120rpx;
            position:absolute;
            left:0;
            top:30rpx;
            image{
                width:100%;
                height:100%;
            }
        }
        .notice-img.new-msg::after{
            width:20rpx;
            height:20rpx;
            background:red;
            border-radius:50%;
            content:'';
            position:absolute;
            right:-9rpx;top:-8rpx;
        }
        .notice-content{
            .notice-name{
                line-height:45rpx;
                height:45rpx;
                display:flex;
            }
            .notice-weixin-type{
                width:62rpx;
                height:36rpx;
                line-height:36rpx;
                text-align:center;
                background: rgba(32,133,255,0.10);
                border-radius: 8rpx;
                font-size: 24rpx;
                color: #2085FF;
                letter-spacing: 0.52rpx;
                margin:6rpx 8rpx 0 0;
            }
            .notice-status{
                font-size: 28rpx;
                color: #333333;
                letter-spacing: 0;
                height:45rpx;
                line-height:45rpx;
                text-align: right;
                flex:1;
            }
            .notice-weixin-type.youxiang{
                color: #FFA100;
                background: rgba(255,161,0,0.10);
            }
            .notice-weixin-name,.notice-msg{
                height:45rpx;
                font-size: 32rpx;
                color: #333333;
                letter-spacing: 0.48rpx;
                line-height:45rpx;
                width:278rpx;
                overflow:hidden;
                white-space:nowrap;
                text-overflow:ellipsis;
            }
            .notice-msg{
                height:48rpx;
                height:48rpx;
                font-size: 24rpx;
                color: #999999;
                letter-spacing: 0;
                margin-top:42rpx;
                width:150rpx;
            }
            .notice-more{
                display: flex;
                .notice-time{
                    font-size: 24rpx;
                    color: #CCC;
                    letter-spacing: 0;
                    margin-top:55rpx;
                    text-align: right;
                    flex:1;
                }
            }
        }
    }
}
.emptyBox{
    width: 100%;
    position: fixed;
    top: 280rpx;
    text-align:center;
    .emptyIcon{
        width:209rpx;
        height:187rpx;
    }
    .emptyText{
        margin-top: 20rpx;
        color:#999999;
        font-size:30rpx;
    }
}
</style>

<!-- 
# 时间格式化
# 标识优选个微信小程序的状态没有
-->