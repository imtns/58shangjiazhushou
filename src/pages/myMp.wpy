<template>
    <view class="myMP">
        <view class="shareContainer" wx:if="{{shareImage}}">
            <image class="img" src="{{shareImage}}" mode="{{scaleToFill}}"></image>
        </view>
        <view class="current">
            <view class="tips">
                当前小程序（可在首页切换）
            </view>
            <view class="list">
                <view class="infos">
                    <view class="logBox">
                        <image class="logo" mode="{{aspectFit}}" src="{{business.current.headImg || 'https://pic8.58cdn.com.cn/bizmp/n_v285d6a16d725a446694db35df23c9db24.png?w=375&h=375'}}"></image>
                    </view>
                    <view class="details">
                        <view class="title"> 
                            <view class="name">{{business.current.nickName}}</view>
                            <button wx:if="{{business.current.mpStatus == 2}}" class="share" plain="{{true}}" open-type="getUserInfo" bindgetuserinfo="onReadytoShare" data-id="{{business.current.id}}">分享</button>
                        </view>
                        <view class="icons">
                            <image class="icon" mode="{{aspectFit}}" src="{{ business.current.app_type === 1 || business.current.app_type === 2 ? 'https://static.58.com/lbg/shangjiaxcxht/zhushou/img/youxiang.png' : 'https://static.58.com/lbg/shangjiaxcxht/zhushou/img/youxiang_grey.png'}}"></image>
                            <image class="icon" mode="{{aspectFit}}" src="{{ business.current.app_type === 2 ? 'https://static.58.com/lbg/shangjiaxcxht/zhushou/img/weixin.png' : 'https://static.58.com/lbg/shangjiaxcxht/zhushou/img/weixin_grey.png'}}"></image>
                        </view>
                        <view class="deadline">有效期至 {{business.current.expiryDate}}</view>
                    </view>
                </view>
                <view class="btns">
                    <view bindtap="shouquan" wx:if="{{business.current.app_type === 2}}" :class="{ first: business.current.status === 1 }">{{business.current.status === 1 ? '重新授权' : '去授权'}}</view>
                    <view bindtap="decorate" :class="{'grey': !business.current.address, 'first': !(business.current.status === 1)}" data-address="{{business.current.address}}" data-id="{{business.current.id}}">装修</view>
                    <view bindtap="checkDetail" data-address="{{business.current.address}}" data-id="{{business.current.id}}">查看</view>
                </view>
            </view>
        </view>
        <view class="others" wx:if="{{business.mps.length}}">
            <view class="tips">
                <view>其他小程序</view>
                <view></view>
            </view>
            <repeat for="{{business.mps}}" key="index" index="index" item="item">
                <view class="list">
                    <view class="infos">
                        <view class="logBox">
                            <image class="logo" mode="{{aspectFit}}" src="{{item.headImg || 'https://pic8.58cdn.com.cn/bizmp/n_v285d6a16d725a446694db35df23c9db24.png?w=375&h=375'}}"></image>
                        </view>
                        <view class="details">
                            <view class="title"> 
                                <view class="name">{{item.nickName}}</view>
                                <button wx:if="{{item.mpStatus == 2}}" class="share" plain="{{true}}" open-type="getUserInfo" bindgetuserinfo="onReadytoShare" data-id="{{item.id}}">分享</button>
                            </view>
                            <view class="icons">
                                <image  class="icon" mode="{{aspectFit}}" src="{{ item.app_type === 1 || item.app_type === 2 ? 'https://static.58.com/lbg/shangjiaxcxht/zhushou/img/youxiang.png' : 'https://static.58.com/lbg/shangjiaxcxht/zhushou/img/youxiang_grey.png'}}"></image>
                                <image class="icon" mode="{{aspectFit}}" src="{{ item.app_type === 2 ? 'https://static.58.com/lbg/shangjiaxcxht/zhushou/img/weixin.png' : 'https://static.58.com/lbg/shangjiaxcxht/zhushou/img/weixin_grey.png'}}"></image>
                            </view>
                            <view class="deadline">有效期至 {{item.expiryDate}}</view>
                        </view>
                    </view>
                    <view class="btns">
                        <view bindtap="shouquan" wx:if="{{item.app_type === 2}}" :class="{ first: item.status === 1 }" data-status="{{item.status}}">{{item.status === 1 ? '重新授权' : '去授权'}}</view>
                        <view wx:if="{{item.app_type === 1}}" :class="{ 'first': !(item.status === 1) }" @tap="buy({{ item.id }})">升级</view>
                        <view :class="{'grey': !item.address}" bindtap="decorate" data-address="{{item.address}}">装修</view>
                        <view bindtap="checkDetail" data-address="{{item.address}}" data-id="{{item.id}}">查看</view>
                    </view>
                </view>
            </repeat>
        </view>
        <button class="buy" @tap="buy">购买新的小程序</button>
    </view>
</template>

<script>
import wepy from 'wepy';

import { alert } from '../utils';
import { post } from '../utils/ajax';
import CouponMixin from '../mixin/coupon';
import Mixin from '../mixin';
import { SendClickLog } from '../utils/maidian';

export default class Index extends wepy.page {
    data = {
        business: {
            mps: [],
            current: {
                src: 'https://static.58.com/lbg/shangjiaxcxht/zhushou/img/code7.png',
                deadLine: '2018-09-98',
            },
        },
        shareImage: '',
    }
    mixins = [CouponMixin, Mixin];
    config = {
        navigationBarTitleText: '我的小程序',
    }
    methods = {
        buy(mpId) {
            if (typeof mpId !== 'string') {
                mpId = '';
            }
            this.buyMiniProgram(mpId);
        },
        shouquan() {
            alert('请您登录电脑端，打开https://yaofa.58.com，到授权管理页点击右上角授权按钮去授权', '提示');
        },
        decorate(type) {
            SendClickLog('sjzh_click_myapp_decorate_app');
            if (type.target.dataset.address) {
                const { id, authorizerAppid } = type.target.dataset;
                // wepy.navigateTo({
                //     url: `UploadInfo?mpid=${id}`,
                // });
                wepy.navigateTo({
                    url: `/pages/templateList?mpid=${id}&appid=${authorizerAppid}`,
                });
            }
        },
        // upgrade(type) {
        //     const { id } = type.target.dataset;
        //     wepy.navigateTo({
        //         url: `purchase?mpid=${id}`,
        //     });
        // },
        checkDetail(type) {
            if (type.target.dataset.address) {
                const { id } = type.target.dataset;
                wepy.navigateTo({
                    url: `AppInfo?mpid=${id}`,
                });
            } else {
                const { id } = type.target.dataset;
                wepy.navigateTo({
                    url: `AppEdit?mpid=${id}`,
                });
            }
        },
        onReadytoShare(e) {
            SendClickLog('sjzh_click_myapp_decorate_shareapp');
            const { id } = e.target.dataset;
            const { userInfo } = e.detail;
            // 分享会先授权
            if (!userInfo) {
                alert('您未授权，商家助手不能为您生成分享图片哦', '提示');
                return;
            }
            const { nickName } = userInfo;
            this.getMpShareImg(id, nickName);
        },
    }
    async onShow() {
        const currentMpid = wepy.getStorageSync('current_mpid') || '';
        const subData = {
            mpid: currentMpid,
        };
        const { data } = await post('/mplogic/mymplist', subData);
        let mps = data.mpinfos;

        // 格式化时间，通过mixin/coupon.js
        mps = mps.map(item => {
            const result = Object.assign({}, item);
            result.expiryDate = this.formatTime(result.expiryDate);

            return result;
        });

        const [currentMp] = mps.filter((item) => item.id === currentMpid);
        if (currentMp && currentMp.headImg && currentMp.headImg.indexOf('http') === -1) {
            currentMp.headImg = `https://pic1.58cdn.com.cn${currentMp.headImg}`;
        }

        const others = mps.filter((item) => item.id !== currentMpid);
        let othersMp = [];
        if (others.length > 0) {
            othersMp = others.map(element => {
                const item = element;
                if (item.headImg && item.headImg.indexOf('http') === -1) {
                    item.headImg = `https://pic1.58cdn.com.cn${item.headImg}`;
                }
                return item;
            });
        }

        this.business = Object.assign({}, this.business, {
            current: currentMp,
            mps: othersMp,
        });
        this.$apply();
    }
    async getMpShareImg(id, nickName) {
        const subData = {
            mpId: id,
            nickName,
        };
        // 延迟时间，让用户感知loading文案，故意为之。
        const delay = 1500;
        const { data } = await post('/mplogic/share', subData, '', {
            loadingTitle: '图片生成...',
            delay,
        });
        const url = `http://pic1.58cdn.com.cn/${data}`;
        setTimeout(() => {
            wepy.previewImage({
                current: url, // 当前显示图片的http链接
                urls: [url], // 需要预览的图片http链接列表
            });
        }, delay);
        console.log(data);
    }
}
</script>

<style lang="scss">
    .myMP{
        padding: 0 30rpx;
        .tips{
            letter-spacing: 0;
            line-height: 40rpx;
            font-size: 28rpx;
            color: #999999;
            margin: 20rpx 0 16rpx;
        }
        .list{
            background: #FFFFFF;
            box-shadow: 0 1px 10px 0 rgba(0,0,0,0.10);
            padding: 30rpx 26rpx 0 26rpx;
            margin-bottom: 20rpx;
            position: relative;
            .infos{
                display: flex;
                margin-bottom: 28rpx;
                .logBox{
                    margin-top: 6rpx;
                    .logo{
                        width: 124rpx;
                        height: 124rpx;
                        border: 1rpx solid #E7E7E7;
                    }
                }
                .details{
                    flex:1;
                    padding-left: 20rpx;
                    .title{
                        line-height: 40rpx;
                        .share{
                            width: 80rpx;
                            border: none;    
                            position: absolute;
                            font-size: 24rpx;
                            color: #999999;   
                            right: 27rpx;
                            top: 25rpx;     
                            padding: 0;
                            margin: 0;    
                            text-align: right;
                            line-height: inherit; 
                            background: url('https://static.58.com/lbg/shangjiaxcxht/zhushou/img/mp_share.png') no-repeat left;  
                            background-size: 26rpx 26rpx;   
                        }
                        .name{
                            display: inline-block;
                            font-size: 32rpx;
                            color: #333333;
                            width:400rpx;
                            white-space:nowrap;
                            text-overflow:ellipsis;
                            overflow:hidden;
                        }
                    }
                    .icons{
                        margin-top: 8rpx;
                        height: 38rpx;
                        .icon{
                            display: inline-block;
                            width: 66rpx;
                            height: 38rpx;
                            margin-right: 6rpx;
                        }
                    }
                    .deadline{
                        margin-top: 10rpx;
                        line-height: 37rpx;
                        font-size: 26rpx;
                        color: #999999;
                        padding-left: 5rpx;
                    }
                }
            }
            .btns{
                display: flex;
                border-top: 1rpx solid #F3F3F3;
                height: 74rpx;
                line-height: 74rpx;
                font-size: 28rpx;
                color: #333333;
                .grey{
                    color: #CCCCCC;
                }
                view{
                    flex: 1;
                    text-align: center;
                    border-left: 1rpx solid #f3f3f3;
                }
                .first {
                    border: none;
                }
            }
        }
        .shareContainer{
            position: absolute;
            background: #999999;
            width: 100%;
            height: 100%;
            z-index: 100;
            left: 0;
            right: 0;
            .img{
                position: absolute;
                width: 628rpx;
                height: 1110rpx;
                left: 50%;
                top: 50%;
                transform: translate3d(-50%, -50%, 0);
                display: block;
            }
        }
    }

    button.buy {
        color: #fff;
        font-size: 34rpx;
        line-height: 102rpx;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #4E88FF;
        border-radius: 0;
    }
</style>