<template>
    <scroll-view class="home" scroll-y style="height:100vh">
        <guideMask :show.sync="maskShow" :type="maskType"></guideMask>
        <!-- <view class="follow-public" wx:if="{{!isFollow}}">
            <text>关注公众号接收通知</text>
            <navigator class="follow-action" wx:if="{{assistAuth}}" @tap="toFollow">马上关注</navigator>
            <button class="follow-action" wx:elif="{{!assistAuth}}" open-type="getUserInfo" @tap="loadSession">马上关注</button>
        </view> -->
        <view class="add-myapp" wx:if="{{showTip}}" @tap="showAddStep">
            <view class="triangle"></view>
            点击【添加到我的小程序】，快捷访问接单 >
        </view>
        <view class="index-loaded-header">
            <view class="welcome-block">
                <view wx:if="{{userLogin}}" class="welcome-title">欢迎 <text>{{ business.name }}</text></view>
                <view wx:else class="welcome-title">欢迎来到58小程序管理平台</view>
                <view @tap="changeIdentity" class="item-switch">账号切换</view>
            </view>
            <view class="item-detail">
                <view wx:if="{{userLogin}}">
                    <view class="item-name" :class="{logoPadding : business.mpCount > 0 }">{{ business.miniProgramName }}</view>
                    <view class="item-title" :class="{logoPadding : business.mpCount > 0 }">
                        <view class="star-box" wx:if="{{ business.selected.score }}">
                            <view class="unstar-list">
                                <view class="icon-unstar" wx:for="{{ [0, 1, 2, 3, 4] }}" wx:key="index"></view>
                            </view>
                            <view class="star-list" style="width:{{ 30 * (~~(business.selected.score / 1)) + 22 * (business.selected.score % 1) }}rpx">
                                <view class="icon-star" wx:for="{{ [0, 1, 2, 3, 4] }}" wx:key="index"></view>
                            </view>
                            <view class="star-box-title" @tap="shopScore">店铺评分</view>
                        </view>
                        <view wx:else>可上传素材、提交注册信息到当前小程序</view>
                    </view>
                    <view @tap="changeAction" wx:if="{{business.mpCount >= 2}}" class="item-switch">小程序切换</view>
                    <image class="haslogo" wx:if="{{business.mpCount > 0 }}" mode="{{aspectFit}}" src="{{business.selected.headImg ||'https://pic8.58cdn.com.cn/bizmp/n_v285d6a16d725a446694db35df23c9db24.png?w=375&h=375'}}"></image>
                </view>
                <view wx:if="{{!userLogin}}" class="unlogin">
                    <text class="login-tip">您还没有登录，授权登录后可管理小程序赚大钱</text>
                    <view wx:if="{{editDialog.action=='tologin'}}" class="login-btn" @tap="handleLogin">立即登录</view>
                </view>
                <view wx:if="{{userLogin}}" class="index-block-body index-item">
                    <view class="index-loaded-item {{item.text === '通知' && business.unread ? 'new-msg' : ''}}" :class="{new-mingpian: item.text === '名片管理'}" wx:for="{{items}}" wx:key="index" bindtap="link({{item.text}})">
                        <image src="{{item.iconPath}}" class="item-img"></image>
                        <view class="item-text">{{item.text}}</view>
                    </view>
                </view>
                <view wx:if="{{!userLogin}}" class="index-block-body index-item" @tap="handleLogin">
                    <view class="index-loaded-item {{item.text === '通知' && business.unread ? 'new-msg' : ''}}" :class="{new-mingpian: item.text === '名片管理'}" wx:for="{{items}}" wx:key="index">
                        <image src="{{item.iconPath}}" class="item-img"></image>
                        <view class="item-text">{{item.text}}</view>
                    </view>
                </view>
                <view wx:if="{{userLogin}}" bindtap="checkProgress" class="item-detail-progress">
                    <view class="current-progress"></view>
                    <view class="remind-title">{{ business.progressText}}</view>
                </view>

                <view wx:if="{{!userLogin}}" class="item-detail-progress" @tap="handleLogin">
                    <view class="current-progress"></view>
                    <view class="remind-title">{{ business.progressText}}</view>
                </view>
            </view>
        </view>
        <view class="index-block" wx:for="{{nItems}}" wx:for-item="nItem" wx:key="{{nItem.title}}">
            <view class="index-block-title">{{nItem.title}}</view>
            <view wx:if="{{userLogin}}" class="index-block-body">
                <view class="index-loaded-item new-margin {{item.text === '店铺装修' ? 'shangxin' : ''}}" wx:for="{{nItem.items}}" wx:key="index" bindtap="link({{item.text}})">
                    <image src="{{item.iconPath}}" class="item-img"></image>
                    <view class="item-text">{{item.text}}</view>
                </view>
            </view>
            <view wx:if="{{!userLogin}}" class="index-block-body" @tap="handleLogin">
                <view class="index-loaded-item new-margin {{item.text === '店铺装修' ? 'shangxin' : ''}}" wx:for="{{nItem.items}}" wx:key="index" bindtap="link({{item.text}})">
                    <image src="{{item.iconPath}}" class="item-img"></image>
                    <view class="item-text">{{item.text}}</view>
                </view>
            </view>
        </view>
        <view wx:if="{{business.changeMP === true}}" class="mask" @tap="bindHideMask"></view>
        <view wx:if="{{business.changeMP === true }}" class="mpBox">
            <view class="default">
                <view class="name logoPadding">{{business.miniProgramName}}</view>
                <view>默认</view>
                <image class="haslogo" mode="{{aspectFit}}" src="{{business.selected.headImg ||'https://pic8.58cdn.com.cn/bizmp/n_v285d6a16d725a446694db35df23c9db24.png?w=375&h=375'}}"></image>
            </view>
            <view class="otherBox">
                <repeat for="{{business.mps}}" key="index" index="index" item="item">
                    <view class="mpbox">
                        <view bindtap="selectMp({{item}})" class="mpItem logoPadding" data-appid="{{item.id}}" :class="{ 'active' : item.id === business.chosedId}">{{item.nickName || item.id}}</view>
                        <image class="haslogo" mode="{{aspectFit}}" src="{{item.headImg ||'https://pic8.58cdn.com.cn/bizmp/n_v285d6a16d725a446694db35df23c9db24.png?w=375&h=375'}}"></image>
                    </view>
                </repeat>
            </view>
            <view class="btnBox">
                <view class="cancle" @tap="bindHideMask">取消</view>
                <view class="confirm" :class="{ 'active' : business.canConfirm}" bindtap="confirmAction">确定</view>
            </view>
        </view>
        <!-- 去授权 -->
        <view wx:if="{{!assistAuth && showModal && storageShowmodal}}">
            <view class="showModal_mask" bindtap="hideModal"></view>
            <view class="showModal_modal auth_modal">
                <view class="showModal_text">各位老板，您需要<text>授权</text>后商家助手才能给您提供更好的服务哦</view>
                <button class="showModal_btn" open-type="getUserInfo" bindgetuserinfo="loadSession">去授权</button>
                <button class="showModal_cancle" bindtap="hideModal"></button>
            </view>
        </view>
        <view wx:if="{{assistAuth && !isFollow && showModal && storageShowmodal}}">
            <view class="showModal_mask" bindtap="hideModal"></view>
            <view class="showModal_modal follow_modal">
                <view class="showModal_text">各位老板，您<text>关注公众号</text>后商家助手才能及时给您通知订单消息哦</view>
                <navigator class="showModal_btn" @tap="toFollow">去关注</navigator>
                <button class="showModal_cancle" bindtap="hideModal"></button>
            </view>
        </view>
        <!-- 未编辑过名片提示 -->
        <view class="toedit-modal" wx:if="{{share.showEditModal}}">
            <view class="toedit-con">
                <view class="edit-title">提示</view>
                <view class="edit-tip">{{editDialog.tip}}</view>
                <view class="edit-action">
                    <view class="cancle-btn" @tap="cancleEdit">{{editDialog.leftButton}}</view>
                    <!-- 去客服消息公众号 -->
                    <button wx:if="{{editDialog.action=='topublic'}}" open-type="contact" class="edit-btn">{{editDialog.rightButton}}</button>
                    <!-- 去58验证小程序登录 -->
                    <view wx:if="{{editDialog.action=='tologin'}}" class="edit-btn" @tap="handleLogin">
                        去登录
                    </view>
                    <view wx:else="{{editDialog.action!='topublic' && editDialog.action!='tologin'}}" class="edit-btn" @tap="toEdit" data-action="{{editDialog.action}}">{{editDialog.rightButton}}</view>
                </view>
            </view>
        </view>
        <!-- 分享名片赢大奖提示 -->
        <!-- <view class="toedit-modal" wx:if="{{Actfrom || share.hasPromptToday && share.hasPerm}}">
            <form bindsubmit="handleFormidCollect" report-submit="true">
                <button class="share-active-cancle" data-action="cancle" bindtap="handleActionRoute" hover-class="none" form-type="submit"></button>
            </form>
            <view class="share-active-con">
                <view class="share-countdown" wx:if="{{share.cashDistance > 0}}">
                    倒计时：
                    <view class="time-countdown">{{share.timeArray[0]}}</view>
                    <view>天</view>
                    <view class="time-countdown">{{share.timeArray[1]}}</view>
                    <view>时</view>
                    <view class="time-countdown">{{share.timeArray[2]}}</view>
                    <view>分</view>
                    <view class="time-countdown">{{share.timeArray[3]}}</view>
                    <view>秒</view>
                </view>
                <view class="share-tips" wx:if="{{share.cashDistance > 0}}">
                    <view class="share-days">您已分享了{{share.hasShareDays}}天</view>
                    <navigator class="share-intro" hover-class="none" url="/pages/activityIntro">活动规则 ></navigator>
                </view>
                <view class="share-ending" wx:if="{{share.cashDistance <= 0 && share.needShareDays > share.hasShareDays}}">活动结束，您没有达到累计分享{{share.needShareDays}}天的活动要求，再接再厉，期待在之后的活动中赢取大奖</view>
                <view class="share-ending" wx:if="{{share.cashDistance <= 0 && share.hasShareDays >= share.needShareDays}}">活动结束，您达到了累计分享{{share.needShareDays}}天的活动要求，请去"58同城微学院"公众号瓜分奖金</view>
            </view> -->
            <!-- 活动结束,未获奖 -->
            <!-- <form bindsubmit="handleFormhandleFormidCollectidCollect" report-submit="true" wx:if="{{share.cashDistance <= 0 && share.needShareDays > share.hasShareDays}}">
                <button hover-class="none" form-type="submit" class="toshare-btn" data-action="topubnumber" bindtap="handleActionRoute">到公众号看更多赚钱秘籍</button>
            </form> -->
            <!-- 活动结束,获奖 -->
            <!-- <form bindsubmit="handleFormidCollect" report-submit="true" wx:if="{{share.hasShareDays >= share.needShareDays}}">
                <button hover-class="none" form-type="submit" class="toshare-btn" data-action="toshareprize" bindtap="handleActionRoute">去"58同城微学院"瓜分奖金</button>
            </form> -->
            <!-- 若是今天已分享，则分享按钮置灰，今日不可再次分享 -->
            <!-- <form bindsubmit="handleFormidCollect" report-submit="true" wx:if="{{share.cashDistance > 0 && share.hasShareDays && share.hasShareToday && !share.isAuto && share.needShareDays > share.hasShareDays}}">
                <navigator class="toshare-action" hover-class="none" target="miniProgram" open-type="navigate" app-id="wx86c7b0019914401c" path="/pages/index58/index58?mpcardId={{business.selected.cardId}}&businessId={{business.userId}}&from=zhushou_home" extra-data="" version="develop">
                    <button hover-class="none" form-type="submit" class="toshare-btn" data-action="share" bindtap="handleActionRoute">已分享{{share.hasShareDays}}天，明天开始下一次分享</button>
                </navigator>
            </form> -->
            <!-- 若是默认名片没有保存过，则弹窗提示商家去编辑 -->
            <!-- <form bindsubmit="handleFormidCollect" report-submit="true" wx:if="{{share.cashDistance > 0 && !share.hasShareToday && share.isAuto && share.needShareDays > share.hasShareDays}}">
                <button hover-class="none" form-type="submit" class="toshare-btn" data-action="toeditcard" bindtap="handleActionRoute">立即分享</button>
            </form> -->
            <!-- 若不是默认名片，分享跳转到c端名片页 -->
            <!-- <form bindsubmit="handleFormidCollect" report-submit="true" wx:if="{{share.cashDistance > 0 && !share.hasShareToday && !share.isAuto&& share.needShareDays > share.hasShareDays}}">
                <navigator class="toshare-action" hover-class="none" target="miniProgram" open-type="navigate" app-id="wx86c7b0019914401c" path="/pages/index58/index58?mpcardId={{business.selected.cardId}}&businessId={{business.userId}}&from=zhushou_home" extra-data="" version="develop">
                    <button hover-class="none" form-type="submit" class="toshare-btn" data-action="share" bindtap="handleActionRoute">立即分享</button>
                </navigator>
            </form> 
        </view>-->
        <!-- <form bindsubmit="handleFormidCollect" report-submit="true" wx:if="{{!Actfrom && !share.hasPromptToday && share.hasPerm}}">
            <button class="tomake-money" data-action="makemoney" bindtap="handleActionRoute" hover-class="none" form-type="submit"></button>
        </form> -->
        <!-- 每日一言悬浮提示 -->
        <form bindsubmit="handleFormidCollect" report-submit="true" wx:if="{{everydayIconShow}}">
            <button class="to-everyday" @tap="handleToEveryday" hover-class="none" form-type="submit">
                <view class="unread" wx:if="{{everydayIconShow && everydayUnread}}" />
            </button>
        </form>
        <!-- 每日一言弹窗模块 -->
        <everyday-modal :show.sync="everydayShow" :unread.sync="everydayUnread" />
        <!-- 商家推广模块 -->
        <spread-modal 
            :userID.sync="spreadUserID"
            :show.sync="spreadRPShow"
            :first.sync="spreadRPFirst"></spread-modal>
        <!-- 添加到我的小程序步骤提示 -->
        <view class="add-myapp-modal" wx:if="{{showTipModal}}">
            <view class="add-step">
                <view class="step-text">
                    1.点击
                    <image src="https://static.58.com/lbg/shangjiaxcxht/zhushou/img/add-step1.png" class="step-image1"></image>
                </view>
                <view class="step-text">2.点击【添加到我的小程序】</view>
                <image src="https://static.58.com/lbg/shangjiaxcxht/zhushou/img/add-step2.png" class="step-image2"></image>
                <view class="step-text">3.在微信首页下拉，快速进入"58商家程序助手"</view>
                <image src="https://static.58.com/lbg/shangjiaxcxht/zhushou/img/add-step3.png" class="step-image3"></image>
                <view class="cancle-btn" @tap="cancleTipModal">
                    <image src="https://static.58.com/lbg/shangjiaxcxht/zhushou/img/add-step4.png"></image>
                </view>
            </view>
        </view>
    </scroll-view>
</template>

<script>
import wepy from 'wepy';
import Mixin from '../mixin';
import RegistMixin from './regist/mixin';

import { items, nItems } from '../utils/homeList';
import { alert, formatDuring } from '../utils';
import { post, get } from '../utils/ajax';
import { globalData, setTabBar } from '../utils/globalData';
import { SendClickLog } from '../utils/maidian';
import { SendEventLog } from '../utils/eventLog';

import {
    CHAT_LOGIN,
    MY_MPLIST,
    SESSION,
    INSERT_SESSION,
    GET_EXT_JSON,
    GET_SHARE,
    CHECK_CANSPREAD,
} from '../utils/url';

import { sdkLogin, onMsgNotify, sdkLogout } from '../utils/IM/IM';
import { chatContactList } from '../store/index';
import loginHelper from '../utils/login';
import * as service from '../utils/service';

import EverydayModal from '../components/EverydayModal';
import Mask from '../components/Mask';
import SpreadModal from '../components/SpreadModal';

export default class Home extends wepy.page {
  mixins = [Mixin, RegistMixin];
  config = {
      navigationBarTitleText: '首页',
      usingComponents: {
          drawimage: 'miniprogram-drawimage',
      },
  };
  components = {
      guideMask: Mask,
      'everyday-modal': EverydayModal,
      'spread-modal': SpreadModal,
  };
  data = {
      code: '',
      iv: '',
      encryptedData: '',
      session: '',
      isFollow: true, // 是否关注公众号
      assistAuth: false, // 是否授权
      showModal: false, // 是否授权或者关注弹框
      showIdentity: false, // 是否显示切换账号弹框
      showTip: false, // 是否展示添加到我的小程序提示
      showTipModal: false, // 是否展示添加到我的小程序引导添加提示
      userLogin: true, // 是否登录
      storageShowmodal: false,
      // 名片引导层弹层
      maskShow: false,
      maskType: 'home',
      Actfrom: '', // 运营活动首页进入来源 ‘app’ || ‘h5’
      business: {
          mps: [],
          name: '',
          miniProgramName: '您还没购买小程序',
          unread: 0,
          unreadOrder: 0,
          mpCount: 0,
          progressText: '您还没有购买小程序',
          nexttask: 0,
          changeMP: false,
          canConfirm: false,
          selected: {
              id: 0,
          },
          chosedId: 0,
      },
      share: {
          hasPerm: false, // 能不能参加活动
          isAuto: false, // 是不是默认名片
          hasPromptToday: false, // 今天需不需要弹框
          hasShareToday: 0, // 今天分享次数
          hasShareDays: 0, // 一共分享天数
          needShareDays: 3, // 分享多少天达标
          cashTime: '2018-10-18', // 开奖日期
          cashDistance: 0, // 开奖距离，单位秒
          cashTotal: 0, // 奖池金额，单位元，可修改
          cashAmount: 0, // 我的中奖金额，单位元
          timeArray: [], // 开奖倒计时数组
          showEditModal: false, // 是否显示去编辑名片弹框
      },
      editDialog: {
          tip: '',
          leftButton: '取消',
          rightButton: '去编辑',
      },
      // 将状态属性收敛到status
      status: {
          loading: true,
      },
      items,
      nItems,

      // 用户注册状态前置检查
      // 快速注册时添加
      // {
      //     vip: false, // 是否购买小程序
      //     // 注册状态
      //     // -1资料审核失败 0默认值、未提交过资料 1新提交审核中 2审核通过
      //     currentAuditStatus: 0,
      //     createMp: false, // 是否创建了小程序
      // },
      registPrecheck: null,
      // 每日一言 是否未读
      everydayUnread: false,
      // 每日一言 是否显示
      everydayShow: false,
      // 每日一言 是否显示每日一言icon
      everydayIconShow: false,
      // 红包推广 是否显示红包推广
      spreadRPShow: false,
      // 红包推广 是否今天第一次进入首页
      spreadRPFirst: false,
      spreadUserID: '',
      fromQuery: '', // 打开来源
  };
  methods = {
      handleLogin() {
          loginHelper.goLogin();
      },
      link(text) {
          if (!this.userLogin) return;
          // console.log(text);意见反馈不做判断
          if (text === '意见反馈') {
              SendClickLog('sjzh_click_home_feedback');
              wepy.navigateTo({
                  url: 'feedback',
              });
          } else if (text === '购买小程序') {
              SendClickLog('sjzh_click_home_buy_app');
              this.buyMiniProgram();
          } else {
              this.checkBeforeJump(text);
          }
      },
      // 关注公众号埋点
      toFollow() {
          SendClickLog('sjzh_click_home_follow');
          wepy.navigateTo({
              url: '/pages/followPublic',
          });
      },
      shopScore() {
          SendClickLog('sjzh_click_home_shopScore');
          wepy.navigateTo({
              url: '/pages/shopScore',
          });
      },
      checkProgress() {
          if (!this.userLogin) return;
          if (!this.business.mpCount) {
              alert('您还未购买小程序，请登录e.58.com进行购买', '提示');
              return;
          }
          SendClickLog('sjzh_click_home_progressText');
          switch (this.business.nexttask) {
              case 2:
                  wepy.navigateTo({
                      url: 'AppEdit',
                  });
                  break;
              case 3:
                  wepy.navigateTo({
                      url: 'UploadInfo',
                  });
                  break;
              case 4:
                  if (this.business.selected.app_type === 2) {
                      wepy.setStorageSync('registMappid', this.business.selected.id);
                      wepy.navigateTo({
                          url: 'registMainAccount',
                      });
                  } else {
                      wepy.navigateTo({
                          url: 'progress',
                      });
                  }
                  break;
              case 5:
                  if (this.business.selected.app_type === 1) {
                      wepy.navigateTo({
                          url: 'progress',
                      });
                  } else {
                      wepy.navigateTo({
                          url: 'myMp',
                      });
                  }
                  break;
              case 6:
                  wepy.navigateTo({
                      url: 'progress',
                  });
                  break;
              case 7:
                  wepy.navigateTo({
                      url: 'progress',
                  });
                  break;
              case 8:
                  wepy.navigateTo({
                      url: 'progress',
                  });
                  break;
              case 9:
                  wepy.navigateTo({
                      url: 'progress',
                  });
                  break;
              default:
                  break;
          }
          this.$apply();
      },
      async changeAction() {
          SendClickLog('sjzh_click_home_switch_app');
          this.business = Object.assign({}, this.business, {
              changeMP: true,
          });
          const { data } = await post(MY_MPLIST);
          const { mpinfos } = data;
          this.business = Object.assign({}, this.business, {
              mps: mpinfos,
          });
          if (this.business.mps.length > 0) {
              const others = this.business.mps.filter(appinfo => appinfo.id !== this.business.selected.id);
              const formatedOther = others.map(item => this.formatedMp(item));
              this.business = Object.assign({}, this.business, {
                  mps: formatedOther,
                  chosedId: 0,
                  canConfirm: false,
              });
          }
          this.$apply();
      },
      bindHideMask() {
          this.business = Object.assign({}, this.business, {
              changeMP: false,
              canConfirm: false,
          });
          this.$apply();
      },
      selectMp(item) {
          this.business = Object.assign({}, this.business, {
              chosedId: item.id,
              canConfirm: true,
          });
          this.$apply();
      },
      changeIdentity() {
          if (!this.userLogin) {
              loginHelper.goLogin();
              return;
          }
          SendClickLog('sjzh_click_home_switch_Identity');
          wepy.navigateTo({
              url: '/pages/app/accountList',
          });
      },
      // 切换账号
      // hideIdentityModal() {
      //     this.showIdentity = false;
      //     this.$apply();
      // },
      // 切换小程序操作
      async confirmAction() {
      // 切换小程序，登出IM
          const { cardId = '' } = this.business.selected;
          if (cardId) {
              sdkLogout(
                  () => {
                      console.log('logout success');
                  },
                  () => {
                      console.log('logout error');
                  },
              );
          }

          if (this.business.selected.id) {
              await this.setGlobalMpId(this.business.chosedId);
              await this.loadData();
              await this.loadExtJson();
              await this.hideMask();
              // 切换小程序，重新登录IM
              await this.chatLogin();
              // 重新判断是否显示推广
              this.initSpreadRedpacket();
          }
      },
      hideModal() {
          this.showModal = false;
          wepy.setStorageSync('showmodal', false);
          this.storageShowmodal = wepy.getStorageSync('showmodal');
          this.$apply();
      },
      // 取消编辑小程序
      cancleEdit() {
          this.share.showEditModal = false;
      },
      // 去编辑小程序
      toEdit(e) {
          const that = this;
          const { action } = e.currentTarget.dataset;
          switch (action) {
              case 'topublic':
                  that.share.showEditModal = false;
                  break;
              case 'toeditcard':
                  that.share.showEditModal = false;
                  wepy.navigateTo({
                      url: 'newBizCard',
                  });
                  break;
              default:
                  break;
          }
      },
      /**
     * 事件操作：表单提交 收集formId
     * 收集formid操作：去分享，关闭，去赚钱
     */
      handleFormidCollect(e) {
          const { formId } = e.detail;
          this.requestFormidCollect(formId);
      },
      // 展示添加到我的小程序弹框提示
      showAddStep() {
          this.showTip = false;
          this.showTipModal = true;
          wepy.setStorageSync('showAddModal', true);
          this.$apply();
      },
      // 关闭添加到我的小程序弹框提示
      cancleTipModal() {
          this.showTipModal = false;
          this.$apply();
      },
      // 每日一言
      handleToEveryday() {
          const seft = this;
          seft.everydayShow = true;
          seft.$apply();
          SendClickLog('sjzh_click_home_toeveryday');
      },
  };
  async onLoad(options) {
      if (options.mask && !wepy.getStorageSync('mask')) {
          this.maskShow = true;
      }
      // from=daypic 打开每日一言的弹窗
      // from=redpacket 打开红包推广
      this.fromQuery = options.from || '';
      // 记录from
      SendEventLog({
          page: 'home',
          action: 'show',
          extend: this.fromQuery ? JSON.stringify({ from: this.fromQuery }) : '',
      });
      try {
      // 快速注册判断跳转
      // 如果用户在快速注册的流程中，则让用户跳转到注册流程的相应页面
          this.checkRegistStatus()
              .then(msg => {
                  console.log(msg);
              })
              .catch(err => {
                  console.log(err);
              });

          await this.loadData();
          if (!this.userLogin) return;
          // 每日一言 打开弹窗
          const cardId = wepy.getStorageSync('current_cardId');
          if (cardId && this.fromQuery === 'daypic') {
              this.everydayShow = true;
          }
          // 聊天登录，监控未读消息
          const { token } = globalData.chat;
          if (!token) {
              this.chatLogin();
          }
          // globalData.extConfig和current_mpid只需要在load和切换小程序的时候重新设置，所以在load里边要调用loadData
          this.setGlobalMpId(this.business.selected.id);
          this.loadExtJson();
          wepy.setStorageSync('showmodal', true);
          this.storageShowmodal = wepy.getStorageSync('showmodal');
          if (!this.isFollow && wepy.getStorageSync('ppu')) {
              this.showModal = true;
          }

          // wepy在链式更改属性时，在手机预览会出现不生效的情况。
          this.status.loading = false;
          this.$apply();
      } catch (err) {
          console.log(err);
      }
  }
  async onShow() {
      try {
          await this.loadData();
          if (!this.userLogin) return;
          // 初始化红包推广活动
          this.initSpreadRedpacket();
          SendClickLog('sjzh_click_home_onload');
          await this.loadShareActivity();
          this.loadCode();
          this.getInfo();
          this.hideTipModal();
          await this.getAssistAuth();
          if (!this.isFollow && wepy.getStorageSync('ppu')) {
              this.showModal = true;
              this.$apply();
          }
      } catch (err) {
          console.log(err);
      }
  }
  formatedMp(item) {
      const mp = item;
      if (mp && mp.headImg && mp.headImg.indexOf('http') === -1) {
          mp.headImg = `https://pic1.58cdn.com.cn${mp.headImg}`;
      }
      return mp;
  }
  /**
   * 5s关闭添加到我的小程序提示
   */
  hideTipModal() {
      if (!wepy.getStorageSync('showAddModal')) {
          this.showTip = true;
          setTimeout(() => {
              this.showTip = false;
              wepy.setStorageSync('showAddModal', true);
          }, 5000);
      }
  }
  /**
   * 倒计时计时器
   */
  countDown() {
      const timeNow = parseInt(new Date().getTime());
      const timeEnd = parseInt(new Date(this.share.cashTime.replace(/-/g, '/')).getTime());
      const deadTime = parseInt(timeEnd - timeNow);
      this.share.timeArray = formatDuring(deadTime);
      this.$apply();
  }
  /**
   * 数据请求：收集FormID,用于给用户推送服务通知
   */
  requestFormidCollect(formId) {
      const seft = this;
      if (formId) {
          get('/formidcollect/collect', {
              consumerId: seft.business.userId || '', // 当前用户 ID
              formId,
          });
      }
  }
  /**
   * 事件操作：所有操作入口
   */
  handleActionRoute(e) {
      const seft = this;
      const { action } = e.currentTarget.dataset;
      seft.Actfrom = '';
      this.$apply();
      switch (`${action}`) {
          case 'cancle': // 关闭分享赢大奖弹框
              seft.share.hasPromptToday = false;
              // clickLog = 'cancle';
              break;
          case 'makemoney': // 去赚钱
              seft.share.hasPromptToday = true;
              // clickLog = 'makemoney';
              break;
          case 'toeditcard': // 去赚钱
              seft.editDialog = {
                  tip: '您还没有编辑过名片信息，需编辑保存后再分享赚大钱',
                  action: 'toeditcard',
                  leftButton: '取消',
                  rightButton: '去编辑',
              };
              seft.share.showEditModal = true;
              seft.share.hasPromptToday = false;
              // clickLog = 'makemoney';
              break;
          case 'toshareprize': // 去瓜分奖金
              seft.editDialog = {
                  tip:
            '输入"领奖"发送后获取公众号二维码，长按识别关注公众号快速瓜分10W奖金',
                  action: 'topublic',
                  leftButton: '取消',
                  rightButton: '去获取',
              };
              seft.share.showEditModal = true;
              seft.share.hasPromptToday = false;
              break;
          case 'topubnumber': // 去公众号获取更多赚钱机会
              seft.share.hasPromptToday = false;
              wepy.navigateTo({
                  url: '/pages/followPublic',
              });
              break;
          default:
              break;
      }
  }
  /**
   * 用户点击右上角分享
   */
  onShareAppMessage(res) {
      if (res.from === 'button') {
      // 来自页面内转发按钮
      }
      return {
          title: '高效管理商家小程序的一站式服务工具',
          path: '/pages/home',
          imageUrl: 'https://static.58.com/lbg/shangjiaxcxht/zhushou/img/share.png',
          success(data) {
              console.log(data);
          },
          fail(err) {
              console.log(err);
          },
      };
  }
  /**
   * 获取分享名片赢大奖弹框接口
   */
  async loadShareActivity() {
      const that = this;
      try {
          const sendData = {
              userId: that.business.userId,
              platform: wepy.getStorageSync('Actfrom') || 'app',
          };
          that.Actfrom = wepy.getStorageSync('Actfrom') || '';
          const { data } = await get(GET_SHARE, sendData);
          that.share = Object.assign(that.share, data);
          // 未开奖倒计时开始
          if (that.share.cashDistance) {
              setInterval(() => {
                  that.countDown();
              }, 1000);
          } else {
              clearInterval(() => {
                  that.countDown();
              });
          }
          that.$apply();
      } catch (error) {
          console.log(error);
      }
  }
  async getAssistAuth() {
      try {
          const data = await service.getAssistAuth();
          const { isFollow, assistInfo } = data;
          // 9.13 王研需求修改
          if (assistInfo && assistInfo.wechatUnionId) {
              // 是否授权
              this.assistAuth = true;
          } else {
              this.assistAuth = false;
          }
          this.isFollow = isFollow;
          this.showModal = true;
          this.$apply();
      } catch (e) {
          console.log(e);
      }
  }
  // 获取授权数据
  async loadSession(e) {
      const that = this;
      if (e.detail.errMsg === 'getUserInfo:ok') {
          const { iv, encryptedData } = e.detail;
          that.iv = iv;
          that.encryptedData = encryptedData;
          that.$apply();
          try {
              const { data } = await get(SESSION, { code: that.code });
              const { sessionKey } = data;
              const { state, msg } = await get(INSERT_SESSION, {
                  encryptedData: that.encryptedData,
                  iv: that.iv,
                  session: sessionKey,
              });
              if (state === 100) {
                  that.getAssistAuth();
              }
              if (state === 0) {
                  alert(msg);
              }
          } catch (error) {
              console.log(error);
          }
      } else {
          console.log(e.detail.errMsg);
          alert('由于您拒绝了授权，后续功能不能使用。');
      }
  }
  loadCode() {
      const that = this;
      wx.login({
          success: res => {
              if (res.code) {
                  that.code = res.code;
                  // 查看是否授权
              } else {
                  console.log('获取code失败');
              }
          },
      });
  }
  getInfo() {
      const that = this;
      // 已经授权，可以调用getuseinfo获取头像昵称
      wx.getUserInfo({
          success: res => {
              const { iv, encryptedData } = res;
              that.iv = iv;
              that.encryptedData = encryptedData;
              that.$apply();
          },
      });
  }
  hideMask() {
      this.business = Object.assign({}, this.business, {
          changeMP: false,
          canConfirm: false,
      });
      this.$apply();
  }
  // 获取当前小程序的extjson
  async loadExtJson() {
      const { data } = await get(GET_EXT_JSON, {
          sceneKey: wx.getStorageSync('current_mpid'),
      });
      globalData.extConfig = data;
  }
  async loadData() {
      try {
          const subData = {
              mpid: wepy.getStorageSync('current_mpid') || '',
          };
          const { data } = await post('/mplogic/index', subData);
          const {
              username = '',
              mpinfo = {},
              unread = 0,
              unreadOrder = 0,
              count = 0,
              nexttask = '',
              score,
              cardId = '',
              productType,
          } = data;
          const formatedMpinfo = this.formatedMp(mpinfo);
          globalData.mpType = mpinfo.app_type;
          globalData.userLogin = true;
          this.business = Object.assign({}, this.business, {
              name: username,
              miniProgramName: mpinfo.nickName || '您还没购买小程序',
              unread,
              unreadOrder,
              productType,
              mpCount: count,
              userId: mpinfo.userid,
              selected: {
                  ...formatedMpinfo,
                  score,
                  cardId,
              },
          });
          wepy.setStorageSync('current_cardId', cardId);
          this.initEveryday(); // 每日一言初始化
          nexttask && this.setNextTask(nexttask);
          this.$apply();
          if (unreadOrder) {
              // 未读订单tab
              wx.setTabBarBadge({
                  index: 2,
                  text: unreadOrder.toString(),
              });
          } else {
              wx.removeTabBarBadge({
                  index: 2,
              });
          }
      } catch (e) {
          globalData.userLogin = false;
          this.userLogin = false;
          this.editDialog = {
              tip: '您还未登录，登录后能使用更多功能',
              action: 'tologin',
              leftButton: '取消',
              rightButton: '去完善',
          };
          this.share.showEditModal = true;
          this.$apply();
      }
  }
  setGlobalMpId(id) {
      if (id) {
          wepy.setStorageSync('current_mpid', id);
      }
  }
  checkBeforeJump(text) {
      if (!this.business.mpCount) {
          alert('您还未购买小程序，请登录e.58.com进行购买', '提示');
          return;
      }
      switch (text) {
          case '名片管理':
              SendClickLog('sjzh_click_home_myBizCard');
              if (this.business.productType !== '20001') {
                  alert('您暂无权限使用该功能', '提示');
                  return;
              }
              wepy.navigateTo({
                  url: 'myBizCard',
              });
              break;
          case '通知':
              SendClickLog('sjzh_click_home_noticeList');
              wepy.navigateTo({
                  url: 'noticeList',
              });
              break;
          case '访客记录':
              SendClickLog('sjzh_click_home_visitorLogs');
              if (this.business.productType !== '20001') {
                  alert('您暂无权限使用该功能', '提示');
                  return;
              }
              wepy.navigateTo({
                  url: 'visitorLogs',
              });
              break;
          case '收款记录':
              SendClickLog('sjzh_click_home_paymentRecord');
              wepy.navigateTo({
                  url: 'paymentRecord',
              });
              break;
          case '我的小程序':
              SendClickLog('sjzh_click_home_myMp');
              wepy.navigateTo({
                  url: 'myMp',
              });
              break;
          case '小程序制作':
              SendClickLog('sjzh_click_home_myMp_make');
              if (this.business.selected.app_type === 3) {
                  alert('请升级到优享或企业小程序后使用', '提示');
                  return;
              }
              wepy.navigateTo({
                  url: 'templateList',
              });
              break;
          case '素材管理':
              SendClickLog('sjzh_click_home_resourceManage');
              if (this.business.selected.app_type === 3) {
                  alert('请升级到优享或企业小程序后使用', '提示');
                  return;
              }
              wepy.navigateTo({
                  url: 'resourceManage',
              });
              break;
          case '支付开通':
              SendClickLog('sjzh_click_home_OpenPay');
              wepy.navigateTo({
                  url: 'OpenPay',
              });
              break;
          case '服务':
              SendClickLog('sjzh_click_home_orderComponentGroup');
              wepy.navigateTo({
                  url: 'orderComponentGroup',
              });
              break;
          case '商品':
              SendClickLog('sjzh_click_home_goodsComponentGroup');
              wepy.navigateTo({
                  url: '/pages/goodsComponent/publish',
              });
              break;
          case '文章':
              SendClickLog('sjzh_click_home_articleComponentGroup');
              wepy.navigateTo({
                  url: 'articleComponentGroup',
              });
              break;
          case '优惠劵':
              SendClickLog('sjzh_click_home_couponManage');
              wepy.navigateTo({
                  url: 'couponManage',
              });
              break;
          case '注册小程序':
              SendClickLog('sjzh_click_home_myMp_registed');
              if (this.registPrecheck) {
                  const {
                      vip,
                      currentAuditStatus,
                      createMp,
                      alreadyAuth,
                  } = this.registPrecheck;

                  if (currentAuditStatus === 0 && vip) {
                      wepy.navigateTo({ url: '/pages/regist/index' });
                      return;
                  }

                  if (alreadyAuth && !createMp) {
                      wepy.navigateTo({ url: '/pages/regist/notice' });
                      return;
                  }

                  if (vip && createMp) {
                      alert('您的微信小程序已创建成功，不可重复注册');
                      return;
                  }
              }
              if (this.business.selected.app_type === 1) {
                  alert('当前小程序为优享小程序，不用提交注册信息', '提示');
                  return;
              }
              if (this.business.selected.app_type === 3) {
                  alert('请升级到优享或企业小程序后使用', '提示');
                  return;
              }
              if (this.business.selected.sign === 1) {
                  wepy.navigateTo({
                      url: 'registed',
                  });
              } else {
                  wepy.setStorageSync('registMappid', this.business.selected.id);
                  wepy.navigateTo({
                      url: 'registMainAccount',
                  });
              }
              break;
          case '进度查询':
              SendClickLog('sjzh_click_home_progress');
              wepy.navigateTo({
                  url: 'progress',
              });
              break;
          case 6:
              wepy.navigateTo({
                  url: 'templateList',
              });
              break;
          default:
              break;
      }
  }
  setNextTask(taskNum) {
      this.business = Object.assign({}, this.business, {
          nexttask: taskNum,
      });
      switch (taskNum) {
          case 2:
              this.business.progressText = '当前小程序未添加小程序信息';
              break;
          case 3:
              this.business.progressText = '当前小程序还未上传素材';
              break;
          case 4:
              if (this.business.selected.app_type === 1) {
                  this.business.progressText = '当前小程序信息已完善';
              } else {
                  this.business.progressText = '当前小程序还未填写注册信息';
              }
              break;
          case 5: // 跳转我的小程序
              if (this.business.selected.app_type === 1) {
                  this.business.progressText = '当前小程序信息已完善';
              } else {
                  this.business.progressText = '当前小程序还未授权';
              }
              break;
          case 6: // 跳转到进度
              this.business.progressText = '当前小程序信息已完善';
              break;
          case 7: // 消息列表
              this.business.progressText = '当前小程序信息已完善';
              break;
          case 8: // 消息列表
              this.business.progressText = '当前小程序信息已完善';
              break;
          case 9: // 完成度
              this.business.progressText = '当前小程序信息已完善';
              break;
          default:
              break;
      }
      this.$apply();
  }

  // chatLogin 聊天登录
  async chatLogin() {
      try {
      // 清空全局的聊天数据
          const chat = {
              unReadCount: 0, // 未读消息总数
              token: '', // 消息相关接口必传字段
              nickName: '',
              headImg: '',
              currentContactId: '',
              myId: '', // 当前登录者id
              contactList: [],
          };
          Object.assign(globalData.chat, chat);

          const { cardId = '' } = this.business.selected;
          if (!cardId) return;
          /**
                tim 包含 sdkAppID identifier userSig
                myInfo 包含 token nickName headImg
                unReadCount 未读消息数
            */
          const { data } = await get(CHAT_LOGIN, {
              channel: 1, // channel 身份 1是名片 2是用户
              userId: cardId, // userId 该身份对应的识别id，商家传cardId(名片Id)
          });

          const { tim, myInfo, unReadCount = 20 } = data;
          const { unReadCount: counts } = globalData.chat;
          const text =
        counts && counts > 0 ? counts + Number(unReadCount) : unReadCount;

          setTabBar(text);

          const {
              token, nickName, headImg, id,
          } = myInfo;

          // 设置全局token
          let tempHeadImg = headImg;
          if (headImg.indexOf('http') === -1) {
              tempHeadImg = `https://pic1.58cdn.com.cn${headImg}`;
          }
          Object.assign(globalData.chat, {
              userLogin: true,
              token,
              nickName,
              headImg: tempHeadImg,
              myId: id,
          });
          await chatContactList();
          // IM 登录，获取实时消息
          this.initIM(tim);
      } catch (e) {
          console.log(e);
      }
  }

  initIM(tim) {
      // 当前用户身份
      const loginInfo = {
          accountType: 37611,
      };
      Object.assign(loginInfo, tim);
      // listeners
      const listeners = {
          onMsgNotify: onMsgNotify, // 监听新消息
      };
      sdkLogin(loginInfo, listeners, {});
  }
  // 每日一言
  initEveryday() {
      const seft = this;
      const cardId = wepy.getStorageSync('current_cardId');
      seft.everydayIconShow = !!cardId; // 是否显示每日一言悬浮icon
      seft.$apply();
      console.log(
          '==============>initEveryday = cardId',
          cardId,
          'everydayIconShow=',
          seft.everydayIconShow,
      );
  }
  /**
   * 红包推广
   */
  async initSpreadRedpacket() {
      const mpId = wepy.getStorageSync('current_mpid');
      const { data } = await get(CHECK_CANSPREAD, { mpId });
      // 判断是否有推广功能
      this.spreadRPShow = data.activity;
      // 当天第一次进入首页或者从推送进来则自动显示推广弹窗
      // 如果当天第一次进入但是从每日一言进入的，则不自动弹窗
      this.spreadRPFirst = this.fromQuery === 'redpacket' || (this.fromQuery !== 'daypic' && data.first);
      this.spreadUserID = this.business.userId;
      this.spreadRPFirst && SendEventLog({
          page: 'home',
          button: '',
          window: 'redpacketWindow',
          action: 'show',
      });
      this.$apply();
  }
}
</script>

<style lang="scss">
@import '../css/drawLoading';
page {
  overflow: auto !important;
}
view,
scroll-view {
  box-sizing: border-box;
}
.index-item {
  margin-top: 50rpx;
}
.home {
  width: 100%;
  background: #f6f6f6;
  .mask {
    width: 100%;
    height: 100%;
    position: fixed;
    background: rgba(0, 0, 0, 0.5);
    top: 0;
    bottom: 0;
    z-index: 9;
  }
  .mpBox {
    width: 540rpx;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate3d(-50%, -50%, 0);
    background: white;
    border-radius: 2rpx;
    z-index: 99;
    .name {
      width: 400rpx;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    .haslogo {
      width: 54rpx;
      height: 54rpx;
      position: absolute;
      left: 20rpx;
      top: 30rpx;
      border-radius: 100rpx;
    }
    .logoPadding {
      padding-left: 45rpx;
    }
    .default {
      padding: 0 40rpx;
    }
    .default {
      position: relative;
      height: 113rpx;
      font-size: 28rpx;
      color: #bdbdbd;
      line-height: 113rpx;
      display: flex;
      justify-content: space-between;
    }
    .otherBox {
      font-size: 32rpx;
      color: #666666;
      overflow: scroll;
      max-height: 320rpx;
      .mpbox {
        position: relative;
        padding: 0 40rpx;
      }
      .mpItem {
        .logoPadding {
          padding-left: 45rpx;
        }
        height: 113rpx;
        line-height: 113rpx;
        border-top: 1rpx solid #f6f6f6;
        padding-right: 80rpx;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }
      .active {
        background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/correct-home.png)
          no-repeat right;
        background-size: 34.5rpx 34.5rpx;
        color: #4e88ff;
      }
    }
    .btnBox {
      display: flex;
      height: 113rpx;
      width: 100%;
      line-height: 113rpx;
      .active {
        color: #4e88ff !important;
      }
      view {
        flex: 1;
        background: white;
        text-align: center;
        border: 1rpx solid #f6f6f6;
      }
      .cancle {
        font-size: 34rpx;
        color: #666666;
      }
      .confirm {
        font-size: 34rpx;
        color: #bdbdbd;
      }
    }
  }
  .index-loaded-header {
    width: 100%;
    overflow: hidden;
    .welcome-block {
      width: 100%;
      height: 306rpx;
      background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/welcome-block.png)
        no-repeat;
      background-size: 100% auto;
      padding: 40rpx 40rpx 0 40rpx;
      position: absolute;
      .welcome-title {
        font-size: 36rpx;
        color: #ffffff;
        letter-spacing: 0;
      }
      .msg-box {
        position: absolute;
        right: 40rpx;
        top: 50rpx;
        width: 41rpx;
        height: 31rpx;
        background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACkAAAAfCAYAAAB6Q+RGAAAAAXNSR0IArs4c6QAAAzpJREFUWAnNmMdP1GEQhhcwerDXgyC2owePYoktnowxGmOMsRy88Ccgij0GoxHFFhs2bAcvnvGgwRCMRqKRk11PerImiyD4DJmXfKy7vy2wsJO8mfm+aU8Wthb19PTMicVijagCFaNCsW5AWtHWIiCbCFYVClkSjiaDjJMY5clOfDX64ufhcCUsPYxKfXk8BqTsrwft+GnDQcfeEnTXOfpcCLmD27hnXuGnDiUo+wzwju83V684hJzO5WrU4cmX+ClDAcoeA7zte83tRKU694M0IBJrkEBfEE/OJyjzDfAWktlzwjhSQ3rBWor+eFcbflI+QJlbjG76HnO7tIc4GtJB11Eo0OfEEzVgMDzzDLARyXaHc7lMD+mg6ynu9CnP8BPCQbnGzDHAGz7XXE3iLO4yg3TQDTQI9CnxgEDpN8DrSLYnEdD3Zg7pDRuZ2OVTn+DHJxuc7o4+A7zmc8ztTdVDLjtIB91Eo0BbicelWpDsnnoDvIpk+5LV6Y6i7CGtmcbNSKAtxGM1NMpTZ2+/V5Bsf1S95SjMDdKbtzBAb6GPicdELSRvgA1IdiCqXjmKc4d00EPaiG9GozU89Nwb4GUkaw7zUTENuUPSvAB901b3j/D9QDkb4CXPh84+4aQ1GnKDpLECffeNn/FVSH/6h8S9L/j4kSj8E9dyDh/R2nSU1GcPSdNCFALOtUXcbUcC/Up8H71Dsl4gDvbIXtQl/kgUKPnsIGlYhH4gs0/IvnL0GWd7HU38F7C31Kq+IgLOBnoByY6G+TCmIHNIihcjAX4knh0OU8x9OapG9onmIJqvXOi5N9DzSHYszCsmmRkkhUvQT5/2AT9LQwbimWOg53yuueOJ87hLD0nRUiTA98SDAigY5hnoWSSrU848l9GQFCxDv5CZPQlmhgMGM2b2GVvidlKzOaeGJLkcCfAtcbka8+XZcQrJ6m0Ph+SQJFag315tgDPyBZY4l131vtfcaVSmsxHLthEI8A1xWeKgfJ/ZeUIw+HuKQ8guv3yN1xfzfHP9N5/ddYKTH0FVB7JfMOyXgy7UgFZSgBsWa2NrO5rn2+P2MtDEoZB/C3pgv6JVohbUjQrJjMe4Kv8BnZkdhMJllJAAAAAASUVORK5CYII=);
        background-size: 100% auto;
      }
      .item-switch {
        font-size: 26rpx;
        color: #fff;
        letter-spacing: 0;
        line-height: 60rpx;
      }
      .item-switch {
        color: #fff;
        position: absolute;
        right: 30rpx;
        top: 33rpx;
        &:before {
          width: 18rpx;
          height: 17rpx;
          content: '';
          background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/switchlogin-icon.png)
            no-repeat;
          background-size: 100% 100%;
          position: absolute;
          left: -30rpx;
          top: 50%;
          margin-top: -9rpx;
        }
      }
    }
    .item-detail {
      width: 698rpx;
      background: #fff;
      border-radius: 16rpx;
      position: relative;
      padding: 30rpx;
      margin: 115rpx 26rpx 0;
      .haslogo {
        position: absolute;
        width: 83rpx;
        height: 83rpx;
        border-radius: 100rpx;
        top: 50rpx;
        left: 20rpx;
      }
      .logoPadding {
        padding-left: 90rpx;
      }
      .item-name {
        font-size: 32rpx;
        color: #333333;
        letter-spacing: 0;
        line-height: 65rpx;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        width: 470rpx;
      }
      .item-title,
      .item-switch {
        font-size: 26rpx;
        color: #999999;
        letter-spacing: 0;
        line-height: 60rpx;
      }
      .item-switch {
        color: #4e88ff;
        position: absolute;
        right: 30rpx;
        top: 30rpx;
        &:before {
          width: 34rpx;
          height: 34rpx;
          content: '';
          background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/switchmp-icon.png)
            no-repeat;
          background-size: 100% 100%;
          position: absolute;
          left: -40rpx;
          top: 50%;
          margin-top: -19rpx;
        }
      }
    }
    .item-detail-progress {
      width: 646rpx;
      height: 84rpx;
      line-height: 84rpx;
      background: #edf3ff;
      border-radius: 100px;
      position: relative;
      padding-left: 81rpx;
      box-sizing: border-box;
      &::after {
        display: block;
        position: absolute;
        right: 20rpx;
        top: 50%;
        margin-top: -13rpx;
        content: '';
        width: 15rpx;
        height: 26rpx;
        background: url('https://static.58.com/lbg/shangjiaxcxht/zhushou/img/blue-right-angel.png')
          no-repeat center;
        background-size: 100%;
      }
      .current-progress {
        width: 31rpx;
        height: 26rpx;
        background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/current-msg-icon.png)
          no-repeat;
        background-size: 31rpx 26rpx;
        position: absolute;
        left: 30rpx;
        top: 50%;
        margin-top: -13rpx;
      }
    }
    .remind-title {
      font-family: PingFangSC-Regular;
      font-size: 26rpx;
      color: #6aa1ff;
    }
  }
  .follow-public {
    width: 100%;
    height: 80rpx;
    line-height: 80rpx;
    position: relative;
    font-size: 28rpx;
    color: #ffa710;
    padding: 0 30rpx;
    background: #ffedcf;
    .follow-action {
      color: #ffa710;
      text-align: center;
      line-height: 50rpx;
      font-size: 28rpx;
      height: 50rpx;
      border: 1rpx solid #ffa710;
      border-radius: 5rpx;
      position: absolute;
      right: 30rpx;
      top: 15rpx;
      background: #fff;
      padding: 0 15rpx;
    }
  }
  .index-loaded-body {
    width: 698rpx;
    height: 430rpx;
    padding: 60rpx 30rpx;
    margin: 30rpx 26rpx;
    background: #fff;
    border-radius: 16rpx;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    .index-loaded-item {
      width: 156rpx;
      margin-bottom: 70rpx;
      text-align: center;
      position: relative;
      .item-img {
        width: 72rpx;
        height: 72rpx;
      }
      .item-text {
        font-size: 26rpx;
        color: #333333;
        letter-spacing: 0;
        text-align: center;
        line-height: 32rpx;
        margin-top: 6rpx;
      }
    }
  }
  .index-block .index-loaded-item {
    margin-left: 15rpx;
  }
  .index-block {
    width: 698rpx;
    background: #fff;
    border-radius: 16rpx;
    margin: 30rpx 26rpx;
    .index-block-title {
      height: 72rpx;
      border-bottom: 1rpx solid #f6f6f6;
      padding-left: 30rpx;
      line-height: 72rpx;
      box-sizing: border-box;
      font-family: PingFangSC-Medium;
      font-size: 28rpx;
      color: #333333;
    }
  }

  .index-block-body {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start;
    padding-bottom: 30rpx;
    .index-loaded-item {
      width: 156rpx;
      text-align: center;
      position: relative;
      &.new-msg::after {
        display: block;
        content: '';
        width: 20rpx;
        height: 20rpx;
        background: red;
        border-radius: 50%;
        position: absolute;
        right: 37rpx;
        top: 0;
        z-index: 1;
      }
      &.new-mingpian::after {
        font-size: 18rpx;
        color: #fff;
        display: block;
        content: '';
        width: 52rpx;
        height: 30rpx;
        line-height: 30rpx;
        background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/shangxin-new.png)
          no-repeat;
        background-size: 100% 100%;
        position: absolute;
        right: 13rpx;
        top: -10rpx;
        z-index: 1;
      }
      &.new-margin {
        margin: 30rpx 0 0rpx 15rpx;
      }
      .item-img {
        width: 72rpx;
        height: 72rpx;
      }
      .item-text {
        font-size: 26rpx;
        color: #333333;
        letter-spacing: 0;
        text-align: center;
        line-height: 32rpx;
        margin-top: 6rpx;
      }
    }
    .shangxin.index-loaded-item {
      position: relative;
      &:before {
        content: '';
        width: 52rpx;
        height: 30rpx;
        background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/shangxin-new.png)
          no-repeat;
        background-size: 52rpx 30rpx;
        position: absolute;
        top: -10rpx;
        right: 15rpx;
        font-family: PingFangSC-Regular;
        font-size: 20rpx;
        color: #ffffff;
      }
    }
  }
  .shangxin.index-loaded-item {
    position: relative;
    &:before {
      content: '';
      width: 52rpx;
      height: 30rpx;
      background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/shangxin-new.png)
        no-repeat;
      background-size: 52rpx 30rpx;
      position: absolute;
      top: -10rpx;
      right: 15rpx;
      font-family: PingFangSC-Regular;
      font-size: 20rpx;
      color: #ffffff;
    }
  }
}

.star-box {
  position: relative;
  display: flex;
  margin-top: 16rpx;
}

.star-box-title {
  font-size: 24rpx;
  color: #999;
  margin-left: 12rpx;
  line-height: 24rpx;

  &::after {
    display: inline-block;
    width: 12rpx;
    height: 20rpx;
    content: '';
    background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAaBAMAAACa4xtRAAAAJFBMVEUAAACcnJyZmZmampqampqdnZ2ZmZmcnJyZmZmZmZmZmZmZmZn2rJLyAAAAC3RSTlMAOvOzgyfnGw/iltkIdIcAAAA8SURBVAjXY2AXYICAps1QRvVuAwiDZTdMyJuKQqt3Q2xkzd7UAGaE7VaECQiQK8AJFWCIhgowsBgyoAIAfN4dpEaw3mAAAAAASUVORK5CYII=')
      no-repeat;
    background-size: 12rpx 20rpx;
    margin-left: 8rpx;
    line-height: 24rpx;
  }
}
.unstar-list {
  display: flex;
  .icon-unstar {
    flex: none;
    margin-right: 8rpx;
    width: 22rpx;
    height: 22rpx;
    background: url('/unstar.png') no-repeat;
    background-size: 22rpx 22rpx;
  }
}
.star-list {
  position: absolute;
  top: 0;
  left: 0;
  overflow: hidden;
  display: flex;
  .icon-star {
    flex: none;
    margin-right: 8rpx;
    width: 22rpx;
    height: 22rpx;
    background: url('/star.png') no-repeat;
    background-size: 22rpx 22rpx;
  }
}
.showModal_mask {
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  position: fixed;
  top: 0;
  bottom: 0;
  z-index: 1;
}
.showModal_modal {
  width: 576rpx;
  height: 710rpx;
  z-index: 100;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate3d(-50%, -50%, 0);
  text-align: center;
}
.auth_modal {
  background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/auth-pop.png)
    no-repeat;
  background-size: 100% 100%;
}
.follow_modal {
  background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/public-pop.png)
    no-repeat;
  background-size: 100% 100%;
}
.showModal_title {
  font-size: 36rpx;
  color: #333333;
  line-height: 36rpx;
  margin: 60rpx 0 30rpx 0;
}
.showModal_text {
  font-size: 30rpx;
  color: #666;
  padding: 0 40rpx;
  margin-top: 400rpx;
  text {
    color: #4e88ff;
  }
}
.showModal_btn {
  font-size: 30rpx;
  color: #fff;
  width: 400rpx;
  height: 90rpx;
  line-height: 90rpx;
  background: #4e88ff;
  margin: 80rpx auto 110rpx;
}
.showModal_cancle {
  width: 60rpx;
  height: 60rpx;
  background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/close.png)
    no-repeat;
  background-size: 100% 100%;
}
.showIdentity_modal {
  font-size: 32rpx;
  color: #333;
  width: 100%;
  line-height: 100rpx;
  text-align: center;
  bottom: 0;
  position: fixed;
  z-index: 99;
}
.switch_btn {
  background: #fff;
}
.show_cancle {
  margin-top: 12rpx;
  background: #fff;
}
.toedit-modal {
  position: fixed;
  width: 100%;
  min-height: 100vh;
  top: 0;
  left: 0;
  z-index: 99;
  text-align: center;
  background: rgba(0, 0, 0, 0.7);
  transition: all 0.6s ease-in-out;
}
.toedit-con {
  width: 74%;
  text-align: center;
  margin: 45% 13% 0 13%;
  padding-top: 50rpx;
  background: #fff;
  border-radius: 8rpx;
  z-index: 100;
}
.edit-title {
  font-size: 36rpx;
  color: #000;
}
.edit-tip {
  font-size: 28rpx;
  color: #999;
  line-height: 40rpx;
  margin: 20rpx 70rpx 30rpx;
}
.edit-action {
  font-size: 36rpx;
  border-top: 1rpx solid #e5e5e5;
  line-height: 100rpx;
  display: flex;
}
.cancle-btn {
  color: #666;
  flex: 1;
  border-right: 1rpx solid #e5e5e5;
}
.edit-btn {
  color: #4e88ff;
  flex: 1;
}
.share-active-cancle {
  width: 74rpx;
  height: 74rpx;
  background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/home-cancle-btn.png)
    no-repeat;
  background-size: 100% 100%;
  float: right;
  margin: 40rpx 40rpx 0 0;
  overflow: hidden;
}
.share-active-con {
  width: 100%;
  height: 749rpx;
  background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/home-pop-bg.png)
    no-repeat;
  background-size: 100% 100%;
  margin-top: 110rpx;
  position: relative;
}
.toshare-action {
  width: 100%;
  height: 100%;
  background: none;
  margin-top: 40rpx;
}
.toshare-btn {
  font-size: 36rpx;
  color: #fff;
  min-width: 74%;
  display: inline-block;
  padding: 0 66rpx;
  line-height: 110rpx;
  margin: 40rpx auto 0;
  box-sizing: border-box;
  background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/share-btn-bg.png)
    no-repeat;
  background-size: 100% 100%;
}
.shared-btn {
  font-size: 32rpx;
  color: #fff;
  width: 74%;
  padding: 0 30rpx;
  line-height: 110rpx;
  margin: 40rpx auto 0;
  box-sizing: border-box;
  background: #999;
  border-radius: 110rpx;
}
.share-countdown {
  font-size: 36rpx;
  color: #fff;
  width: 74%;
  height: 82rpx;
  line-height: 82rpx;
  padding: 0 20rpx;
  background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/countdown-bg.png)
    no-repeat;
  background-size: 100% 100%;
  position: absolute;
  left: 13%;
  bottom: 100rpx;
  display: flex;
}
.share-countdown view {
  font-size: 28rpx;
  color: #ffbb98;
  flex: 1;
}
.time-countdown {
  color: #6c1a00 !important;
  width: 46rpx;
  height: 52rpx;
  line-height: 52rpx;
  border-radius: 6rpx;
  background: #fff;
  margin-top: 15rpx;
}
.share-tips {
  font-size: 26rpx;
  color: #ffd6d6;
  width: 70%;
  position: absolute;
  left: 15%;
  bottom: 40rpx;
  display: flex;
}
.share-tips .share-days {
  flex: 1;
  text-align: left;
}
.share-tips .share-intro {
  flex: 1;
  text-align: right;
}
.tomake-money {
  position: fixed;
  bottom: 152rpx;
  right: 35rpx;
  width: 143rpx;
  height: 130rpx;
  background: url(https://static.58.com/lbg/shangjiaxcxht/zhushou/img/zhuanqian_icon.png)
    no-repeat;
  background-size: 100% 100%;
  z-index: 59;
}
.share-ending {
  font-size: 28rpx;
  color: #ffd6d6;
  line-height: 40rpx;
  width: 66%;
  text-align: left;
  position: absolute;
  left: 17%;
  bottom: 60rpx;
}
.unlogin {
  text-align: center;
}
.login-tip {
  font-size: 28rpx;
  color: #999;
  text-align: center;
}
.login-btn {
  font-size: 28rpx;
  color: #fff;
  margin: 30rpx auto 70rpx;
  width: 313rpx;
  line-height: 75rpx;
  background-image: linear-gradient(-179deg, #4e88ff 0%, #9b65ff 100%);
  box-shadow: inset 0 9px 20px 0 #69d8ff;
  border-radius: 100px;
}
.add-myapp {
  font-size: 26rpx;
  color: #fff;
  position: fixed;
  top: 20rpx;
  right: 26rpx;
  line-height: 70rpx;
  padding: 0 20rpx;
  background: rgba(0, 0, 0, 0.7);
  transition: all 0.6s ease-in-out;
  border-radius: 4rpx;
  z-index: 2;
}
.triangle {
  display: block;
  width: 0;
  height: 0;
  border-width: 0 5px 8px;
  border-style: solid;
  border-color: transparent transparent rgba(0, 0, 0, 0.7);
  position: absolute;
  top: -8px;
  right: 100rpx; /* 三角形居中显示 */
}
.add-myapp-modal {
  font-size: 32rpx;
  color: #fff;
  position: fixed;
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
  background: rgba(0, 0, 0, 0.7);
  transition: all 0.6s ease-in-out;
  border-radius: 4rpx;
  z-index: 99;
}
.add-step {
  padding-top: 40rpx;
  text-align: center;
}
.step-text {
  line-height: 100rpx;
}
.step-image1 {
  width: 240rpx;
  height: 90rpx;
  margin-bottom: -33rpx;
}
.step-image2 {
  width: 495rpx;
  height: 198rpx;
}
.step-image3 {
  width: 495rpx;
  height: 331rpx;
}
.cancle-btn image {
  margin-top: 30rpx;
  width: 328rpx;
  height: 89rpx;
}
.to-everyday {
  position: fixed;
  bottom: 408rpx;
  right: 30rpx;
  width: 120rpx;
  height: 120rpx;
  background: url('https://img.58cdn.com.cn/lbg/jianzhan/images/youxiang/everyday-word-suspend.png')
    center no-repeat;
  background-size: 100% 100%;
  z-index: 59;

  .unread {
    position: absolute;
    top: 5rpx;
    right: 10rpx;
    width: 20rpx;
    height: 20rpx;
    border-radius: 100%;
    background: #f43530;
  }
}
.everyday-modal {
  position: fixed;
  z-index: 100;
  top: 0;
  left: 0;
  height: 100vh;
  width: 750rpx;
  background: rgba(0, 0, 0, 0.7);

  display: flex;
  justify-content: center;
  align-items: center;

  .everyday-close {
    position: absolute;
    top: 50rpx;
    right: 50rpx;
    z-index: 1;
    width: 58rpx;
    height: 58rpx;
    background: url('https://static.58.com/lbg/shangjiaxcxht/zhushou/img/home-cancle-btn.png')
      center no-repeat;
    background-size: 58rpx 58rpx;
  }

  .everyday-section {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .everyday-pic,
  #everyday-canvas {
    position: relative;
    width: 450rpx;
    height: 800rpx;
  }

  .everyday-banner {
    width: 463rpx;
    height: 60rpx;
    margin: 38rpx auto;
    background: url('https://img.58cdn.com.cn/lbg/jianzhan/images/youxiang/everyday-word-banner.png')
      center no-repeat;
    background-size: 463rpx 60rpx;
  }
  .everyday-btns {
    width: 630rpx;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .everyday-btn {
    width: 300rpx;
    height: 80rpx;
    margin: 0;
    padding: 0;
    border: none;

    background: #fff;
    border-radius: 4rpx;
    display: flex;
    align-items: center;
    justify-content: center;

    .text {
      width: fit-content;
      padding-left: 50rpx;
      font-family: PingFangSC-Regular;
      font-size: 28rpx;
      color: #666666;
      letter-spacing: 0;
      line-height: 80rpx;
      text-align: center;
    }
    &.friend .text {
      background: url('https://img.58cdn.com.cn/lbg/jianzhan/images/youxiang/icon-share-wx.png')
        center left no-repeat;
      background-size: 40rpx 33rpx;
    }
    &.moments .text {
      background: url('https://img.58cdn.com.cn/lbg/jianzhan/images/youxiang/icon-share-pyq.png')
        center left no-repeat;
      background-size: 40rpx 40rpx;
    }
  }
}
</style>
