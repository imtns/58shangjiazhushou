"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,a){function r(n,i){try{var s=t[n](i),o=s.value}catch(e){return void a(e)}if(!s.done)return Promise.resolve(o).then(function(e){r("next",e)},function(e){r("throw",e)});e(o)}return r("next")})}}var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},_modulesParse=require("./../utils/modulesParse.js"),_modulesParse2=_interopRequireDefault(_modulesParse),getPage=require("./../utils/getPage.js"),_require=require("./../utils/ajax.js"),get=_require.get,_require2=require("./../utils/index.js"),picSrcDomain=_require2.picSrcDomain,app=require("./../utils/globalData.js"),pageDataUrl="/business/template/loadall",pageListUrl="/business/pageList/",loadTabbarUrl="/business/getReleaseConfig/",parseCfgAndData=function(e){return e.modules.map(function(e){var t=e.id,a=e.name,r=e.cfg,n=e.data,i=e.params;try{r=r?JSON.parse(r):{}}catch(e){r={}}var s=n[a]||{};if("information"===a&&(s.logo=s.logo?picSrcDomain()+s.logo:"https://pic2.58cdn.com.cn/bizmp/n_v285d6a16d725a446694db35df23c9db24.png",app.globalData.information=s),"coupon"===a&&s.data&&s.data.forEach(function(e){var t=/([0-9]{4})-([0-1]{0,1}[0-9]{1})-([0-3]{0,1}[0-9]{1}).+/,a=JSON.parse(e.couponCondition);1===e.validType?Object.assign(e,_extends({},a,{validStartDate:e.validStarttime.replace(t,"$1.$2.$3"),validEndDate:e.validEndtime.replace(t,"$1.$2.$3")})):Object.assign(e,_extends({},a))}),"order"===a&&(r||(r.hasMore=!1)),"images"!==a&&"order"!==a||(r.theme=r.theme||"1"),"services"!==a&&"serviceOther"!==a||(s.data&&s.data.forEach(function(e){e.img=picSrcDomain()+e.img}),r.theme=r.theme||"1",r.themes=[{theme:"1",styleName:"one",title:"大图"},{theme:"2",styleName:"two",title:"中图"},{theme:"3",styleName:"three",title:"小图"},{theme:"4",styleName:"four",title:"横向滑动"},{theme:"5",styleName:"five",title:"横向列表"},{theme:"6",styleName:"six",title:"双图"},{theme:"7",styleName:"seven",title:"1上2下显示"}]),"serviceDetail"===a){s.descPics&&(s.descPics=s.descPics.map(function(e){return picSrcDomain()+e}));var o=s.serviceInfo.split("\n");s.htmlNodes=o.map(function(e){return{name:"p",children:[{type:"text",text:e}]}})}var c={id:t,name:a,props:_extends({},s,{cfg:r}),params:i};if("imageSwiper"===a){var l=null;l=r.images?r.images:s.data,r.images=l.map(function(e){return _extends({},e,{src:picSrcDomain()+e.src})})}return"images"===a&&r.images.forEach(function(e){e.src=picSrcDomain()+e.src}),"article"===a&&s.data.forEach(function(e){e.cover=picSrcDomain()+e.cover}),"order"===a&&s.data.forEach(function(e){e.pics=picSrcDomain()+e.pics}),console.log(a,c),c})};module.exports={loadData:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var a,r,n,i,s,o,c,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=getPage(this.route,this.options)||"index",r=getCurrentPages()[getCurrentPages().length-1].route,n=r.split("ptype=")[1]||this.options.ptype||"",i={pageKey:a,releaseId:wx.getStorageSync("releaseId"),mpid:wx.getStorageSync("current_mpid")},"detail"===a&&(i.serviceDetailId=this.options.id),"article"===a&&(pageDataUrl="/businessArticle/get/"+this.options.id),"custom"===a&&n&&(i.pageKey=n),console.log(app.globalData.extConfig),e.prev=8,e.next=11,get(pageDataUrl,i);case 11:s=e.sent,o=JSON.parse(JSON.stringify(s.data)),app.globalData.modules=_modulesParse2.default.show(o),c=null,"article"===a?(c=s.data,c.content.replace(/^\s?(http|https)?\\:\/\//,"https://")):c=parseCfgAndData(s.data),l={pageType:a,current:0,page_data:c},"index"===a&&(app.globalData.pageData=c),this.setData(l),t&&t(),e.next=25;break;case 22:e.prev=22,e.t0=e.catch(8),console.log(e.t0);case 25:case"end":return e.stop()}},e,this,[[8,22]])}));return e}(),refreshPage:function(){this.setData({page_data:app.globalData.pageData})},loadTabbar:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,get(loadTabbarUrl+"/"+wx.getStorageSync("releaseId"));case 2:t=e.sent,a=t.data,app.globalData.tabBar=a.tabBar;case 5:case"end":return e.stop()}},e,this)}));return e}(),loadPageList:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log(wx.getStorageSync("releaseId")),e.next=3,get(pageListUrl+"/"+wx.getStorageSync("releaseId"));case 3:t=e.sent,a=t.data,app.globalData.pageList=a;case 6:case"end":return e.stop()}},e,this)}));return e}(),getAppTitle:function(e){get("/mpBusinessInfo/getTitle",function(t,a){if(t||void 0===t)return void(e&&e(t));a&&wx.setNavigationBarTitle({title:a}),e&&e(t,a)})}};