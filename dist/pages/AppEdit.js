"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function a(n,i){try{var o=t[n](i),s=o.value}catch(e){return void r(e)}if(!o.done)return Promise.resolve(s).then(function(e){a("next",e)},function(e){a("throw",e)});e(s)}return a("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e},_slicedToArray=function(){function e(e,t){var r=[],a=!0,n=!1,i=void 0;try{for(var o,s=e[Symbol.iterator]();!(a=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);a=!0);}catch(e){n=!0,i=e}finally{try{!a&&s.return&&s.return()}finally{if(n)throw i}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,r,a){return r&&e(t.prototype,r),a&&e(t,a),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_Cropper=require("./../components/Cropper.js"),_Cropper2=_interopRequireDefault(_Cropper),_utils=require("./../utils/index.js"),_ajaxP=require("./../utils/ajaxP.js"),host="https://yaofa.58.com",uploadApi=host+"/fileUpload",provinceApi="/local/provinces",cityApi="/local/citys/",appinfoApi="/mplogic/get",saveAppApi="/mplogic/modifympinfo",AppEdit=function(e){function t(){var e,r,a,n;_classCallCheck(this,t);for(var i=arguments.length,o=Array(i),s=0;s<i;s++)o[s]=arguments[s];return r=a=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(o))),a.config={navigationBarTitleText:"小程序编辑"},a.components={cropper:_Cropper2.default},a.data={logoUrl:"",loading:!0,mpid:"",areas:[[],[]],selCityIndex:[0,0],markerId:0,form:{city:"1",province:"5001"},tempLogo:"",cateEditable:!0},a.events={"after-crop":function(e){this.uploadLogo(e)}},a.computed={enableSave:function(){return!!(this.form.nickName&&this.form.headImg&&this.form.telphone&&this.form.city&&this.form.address)},markers:function(){return[{iconPath:"/pages/assets/marker.png",id:this.markerId+1,latitude:this.form.addressLatitude||"",longitude:this.form.addressLongitude||"",width:22,height:32}]},longitude:function(){return this.form.addressLongitude},latitude:function(){return this.form.addressLatitude}},a.methods={bindCity:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,a,n,i,o,s,u,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.detail,a=r.column,n=r.value,1!==a){e.next=3;break}return e.abrupt("return");case 3:return i=this.areas[0][n].dispLocalID,e.next=6,(0,_ajaxP.get)(cityApi+i);case 6:if(o=e.sent,s=_slicedToArray(o,2),u=s[0],c=s[1],!u){e.next=13;break}return this.toast(u),e.abrupt("return");case 13:this.areas=[this.areas[0],c],this.$apply();case 15:case"end":return e.stop()}},e,this)}));return e}(),setCity:function(e){var t=e.detail.value,r=t[1]&&0,a=this.areas[0][t[0]],n=this.areas[1][r];this.selCity=[a.localName,n.localName],this.updateForm({province:a.dispLocalID,provinceName:a.localName,city:n.dispLocalID,cityName:n.localName})},setLogo:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,a,n,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,_utils.getNetStatus)();case 3:if(0!==(t=e.sent)){e.next=7;break}return(0,_utils.toastSync)("无网络"),e.abrupt("return");case 7:return e.next=9,_wepy2.default.chooseImage({count:1,sizeType:"compressed "});case 9:return r=e.sent,a=r.tempFilePaths,e.next=13,(0,_utils.alertP)("是否裁剪图片？","提示");case 13:n=e.sent,i=n.confirm,i?this.$broadcast("crop-loadImage",a[0],"1,1",!0):this.uploadLogo(a[0]),e.next=21;break;case 18:e.prev=18,e.t0=e.catch(0),console.log(e.t0);case 21:case"end":return e.stop()}},e,this,[[0,18]])}));return e}(),setAppName:function(e){var t=e.detail.value;return t=(0,_utils.filteremoji)(t),this.updateForm({nickName:t}),{value:t}},setMobile:function(e){var t=e.detail.value;this.updateForm({telphone:t})},setLocation:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,a,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_wepy2.default.chooseLocation();case 2:t=e.sent,r=t.address,a=t.latitude,n=t.longitude,this.updateForm({address:r,addressLatitude:a,addressLongitude:n});case 7:case"end":return e.stop()}},e,this)}));return e}(),setDetailAdress:function(e){var t=e.detail.value;return t=(0,_utils.filteremoji)(t),this.updateForm({address:t}),{value:t}},bindSave:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,a,n,i,o,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.data.form,e.next=3,this.verify();case 3:if(r=e.sent){e.next=6;break}return e.abrupt("return");case 6:return a={mpid:this.mpid,logo:t.headImg,telphone:t.telphone,mpname:t.nickName,privince:t.province,city:t.city,address:t.address,lat:t.addressLatitude,lnt:t.addressLongitude,cate1:t.cate1,cate2:t.cate2,cate3:t.cate3},console.log(a),e.next=10,(0,_ajaxP.get)(saveAppApi,a);case 10:n=e.sent,i=_slicedToArray(n,2),o=i[0],s=i[1],o?this.toast(s.msg):(console.log(s),_wepy2.default.navigateBack());case 15:case"end":return e.stop()}},e,this)}));return e}()},n=r,_possibleConstructorReturn(a,n)}return _inherits(t,e),_createClass(t,[{key:"uploadLogo",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,a,n,i,o,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,_wepy2.default.uploadFile({url:uploadApi,filePath:t,name:"content"});case 3:r=e.sent,a=JSON.parse(r.data),n=a.state,i=a.msg,o=a.data,100===n?(this.tempLogo=t,this.updateForm({headImg:o.content})):this.toast(i),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),s=e.t0.errMsg,this.toast(s);case 13:case"end":return e.stop()}},e,this,[[0,9]])}));return e}()},{key:"onLoad",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.mpid||_wepy2.default.getStorageSync("current_mpid"),r||_wepy2.default.navigateBack(),this.mpid=r,e.next=5,this.getAppInfo(this.mpid);case 5:return this.recordFirstCateStatus(this.form),e.next=8,this.getLocation();case 8:return e.next=10,this.getProvinces();case 10:this.defaultSelCityIndex();case 11:case"end":return e.stop()}},e,this)}));return e}()},{key:"onShow",value:function(){this.updateCateChoice()}},{key:"recordFirstCateStatus",value:function(e){var t=e.mpSource,r=e.cate2;console.log("mpSource",t,"cate2",r),this.cateEditable=!(!t||"3"!==t.toString()||r)||t&&"3"!==t.toString()}},{key:"updateCateChoice",value:function(){var e=_utils.globalService.get("multiSelector"),t=e.cate1,r=void 0===t?"":t,a=e.cate1Name,n=void 0===a?"":a,i=e.cate2,o=void 0===i?"":i,s=e.cate2Name,u=void 0===s?"":s,c=e.cate3,p=void 0===c?"":c,l=e.cate3Name,d=void 0===l?"":l;[r,o,p].every(function(e){return"number"!=typeof e})||this.updateForm({cate1:r,cate1Name:n,cate2:o,cate2Name:u,cate3:p,cate3Name:d})}},{key:"defaultSelCityIndex",value:function(){var e=this.form,t=e.city,r=e.province,a=0,n=0,i=void 0;if(r)for(var o=0,s=this.areas[0].length;o<s;o+=1)if(i=this.areas[0][o],i.dispLocalID===r){a=o;break}if(t)for(var u=0,c=this.areas[1].length;u<c;u+=1)if(i=this.areas[1][u],i.dispLocalID===r){n=u;break}this.selCityIndex=[a,n],this.updateForm({city:this.areas[1][n].dispLocalID,cityName:this.areas[1][n].localName,province:this.areas[0][a].dispLocalID,provinceName:this.areas[0][a].localName})}},{key:"updateForm",value:function(e){var t=e,r=this.data.form;if(""===t.headImg||t.headImg){var a=t.headImg,n=void 0===a?"https://pic8.58cdn.com.cn/bizmp/n_v285d6a16d725a446694db35df23c9db24.png?w=72&h=72":a;n=this.tempLogo||n,n.indexOf("http")<0&&n.indexOf("file:")<0&&(n=(0,_utils.picSrcDomain)()+n+"?w=72&h=72"),this.logoUrl=n}void 0!==t.addressLatitude&&""===t.addressLatitude&&(delete t.addressLatitude,delete t.addressLongitude),this.form=Object.assign({},r,_extends({},t)),this.$apply()}},{key:"getProvinces",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,a,n,i,o,s,u,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,_ajaxP.get)(provinceApi);case 2:if(t=e.sent,r=_slicedToArray(t,2),a=r[0],n=r[1],!a){e.next=9;break}return this.toast(a),e.abrupt("return");case 9:return i=this.form.province||"5001",e.next=12,(0,_ajaxP.get)(cityApi+i);case 12:if(o=e.sent,s=_slicedToArray(o,2),u=s[0],c=s[1],!u){e.next=19;break}return this.toast(u),e.abrupt("return");case 19:console.log("provinces",n,"citys",c),this.areas=[n,c],this.loading=!1,this.$apply();case 23:case"end":return e.stop()}},e,this)}));return e}()},{key:"getLocation",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_wepy2.default.getLocation({type:"wgs84"});case 2:if(t=e.sent,r=t.latitude,a=t.longitude,!this.form.addressLatitude){e.next=7;break}return e.abrupt("return");case 7:this.updateForm({addressLatitude:r,addressLongitude:a});case 8:case"end":return e.stop()}},e,this)}));return e}()},{key:"getAppInfo",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,a,n,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,_ajaxP.get)(appinfoApi+"/"+t);case 2:if(r=e.sent,a=_slicedToArray(r,2),n=a[0],i=a[1],!n){e.next=9;break}return this.toast(n),e.abrupt("return");case 9:this.updateForm(_extends({},i));case 10:case"end":return e.stop()}},e,this)}));return e}()},{key:"toast",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];var a=t[0],n=t[1],i=void 0===n?2e3:n;return _wepy2.default.showToast({title:a,icon:"none",duration:i})}},{key:"verify",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=/^1[3456789][0-9]{9}$/,r=this.data.form,r.headImg){e.next=5;break}return this.toast("请完善信息"),e.abrupt("return",!1);case 5:if(r.nickName){e.next=8;break}return this.toast("输入小程序名称"),e.abrupt("return",!1);case 8:if(!(r.nickName.length<4)){e.next=11;break}return this.toast("小程序名称不得小于4个字"),e.abrupt("return",!1);case 11:if(r.telphone){e.next=14;break}return this.toast("输入联系电话"),e.abrupt("return",!1);case 14:if(!(r.telphone.length<11)||t.test(r.telphone)){e.next=18;break}return e.next=17,(0,_utils.toastSync)("手机号不正确");case 17:return e.abrupt("return",!1);case 18:if(r.city){e.next=21;break}return this.toast("选择城市"),e.abrupt("return",!1);case 21:if(r.address){e.next=24;break}return this.toast("输入详情地址"),e.abrupt("return",!1);case 24:if(r.cate1&&r.cate2){e.next=27;break}return this.toast("所属行业至少选择两项"),e.abrupt("return",!1);case 27:return e.abrupt("return",!0);case 28:case"end":return e.stop()}},e,this)}));return e}()}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(AppEdit,"pages/AppEdit"));