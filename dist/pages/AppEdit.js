"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function n(a,i){try{var s=t[a](i),o=s.value}catch(e){return void r(e)}if(!s.done)return Promise.resolve(o).then(function(e){n("next",e)},function(e){n("throw",e)});e(o)}return n("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},_slicedToArray=function(){function e(e,t){var r=[],n=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){a=!0,i=e}finally{try{!n&&o.return&&o.return()}finally{if(a)throw i}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_utils=require("./../utils/index.js"),_ajaxP=require("./../utils/ajaxP.js"),host="https://yaofa.58.com",uploadApi=host+"/fileUpload",provinceApi="/local/provinces",cityApi="/local/citys/",appinfoApi="/mplogic/get",saveAppApi="/mplogic/modifympinfo",AppEdit=function(e){function t(){var e,r,n,a;_classCallCheck(this,t);for(var i=arguments.length,s=Array(i),o=0;o<i;o++)s[o]=arguments[o];return r=n=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(s))),n.config={disableScroll:!0,navigationBarTitleText:"小程序编辑"},n.data={logoUrl:"",loading:!0,mpid:"",areas:[[],[]],selCityIndex:[0,0],markerId:0,form:{city:"1",province:"5001"},tempLogo:""},n.computed={enableSave:function(){return!!(this.form.nickName&&this.form.headImg&&this.form.telphone&&this.form.city&&this.form.address)},markers:function(){return[{iconPath:"/pages/assets/marker.png",id:this.markerId+1,latitude:this.form.addressLatitude||"",longitude:this.form.addressLongitude||"",width:22,height:32}]},longitude:function(){return this.form.addressLongitude},latitude:function(){return this.form.addressLatitude}},n.methods={bindCity:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,a,i,s,o,u,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.detail,n=r.column,a=r.value,1!==n){e.next=3;break}return e.abrupt("return");case 3:return i=this.areas[0][a].dispLocalID,e.next=6,(0,_ajaxP.get)(cityApi+i);case 6:if(s=e.sent,o=_slicedToArray(s,2),u=o[0],c=o[1],!u){e.next=13;break}return this.toast(u),e.abrupt("return");case 13:this.areas=[this.areas[0],c],this.$apply();case 15:case"end":return e.stop()}},e,this)}));return e}(),setCity:function(e){var t=e.detail.value,r=t[1]&&0,n=this.areas[0][t[0]],a=this.areas[1][r];this.selCity=[n.localName,a.localName],this.updateForm({province:n.dispLocalID,provinceName:n.localName,city:a.dispLocalID,cityName:a.localName})},setLogo:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,a,i,s,o,u,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_wepy2.default.chooseImage({count:1,sizeType:"compressed "});case 2:return t=e.sent,r=t.tempFilePaths,n=r[0],console.log({filePath:n}),e.prev=6,e.next=9,_wepy2.default.uploadFile({url:uploadApi,filePath:n,name:"content"});case 9:a=e.sent,i=JSON.parse(a.data),s=i.state,o=i.msg,u=i.data,100===s?(this.tempLogo=n,this.updateForm({headImg:u.content})):this.toast(o),e.next=19;break;case 15:e.prev=15,e.t0=e.catch(6),c=e.t0.errMsg,this.toast(c);case 19:case"end":return e.stop()}},e,this,[[6,15]])}));return e}(),setAppName:function(e){var t=e.detail.value;return t=(0,_utils.filteremoji)(t),this.updateForm({nickName:t}),{value:t}},setMobile:function(e){var t=e.detail.value;this.updateForm({telphone:t})},setLocation:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_wepy2.default.chooseLocation();case 2:t=e.sent,r=t.address,n=t.latitude,a=t.longitude,this.updateForm({address:r,addressLatitude:n,addressLongitude:a});case 7:case"end":return e.stop()}},e,this)}));return e}(),setDetailAdress:function(e){var t=e.detail.value;return t=(0,_utils.filteremoji)(t),this.updateForm({address:t}),{value:t}},bindSave:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,a,i,s,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.data.form,e.next=3,this.verify();case 3:if(r=e.sent){e.next=6;break}return e.abrupt("return");case 6:return n={mpid:this.mpid,logo:t.headImg,telphone:t.telphone,mpname:t.nickName,privince:t.province,city:t.city,address:t.address,lat:t.addressLatitude,lnt:t.addressLongitude},console.log(n),e.next=10,(0,_ajaxP.get)(saveAppApi,n);case 10:a=e.sent,i=_slicedToArray(a,2),s=i[0],o=i[1],s?this.toast(o.msg):(console.log(o),_wepy2.default.navigateBack());case 15:case"end":return e.stop()}},e,this)}));return e}()},a=r,_possibleConstructorReturn(n,a)}return _inherits(t,e),_createClass(t,[{key:"defaultSelCityIndex",value:function(){var e=this.form,t=e.city,r=e.province,n=0,a=0,i=void 0;if(r)for(var s=0,o=this.areas[0].length;s<o;s+=1)if(i=this.areas[0][s],i.dispLocalID===r){n=s;break}if(t)for(var u=0,c=this.areas[1].length;u<c;u+=1)if(i=this.areas[1][u],i.dispLocalID===r){a=u;break}this.selCityIndex=[n,a],this.updateForm({city:this.areas[1][a].dispLocalID,cityName:this.areas[1][a].localName,province:this.areas[0][n].dispLocalID,provinceName:this.areas[0][n].localName})}},{key:"updateForm",value:function(e){var t=e,r=this.data.form;if(""===t.headImg||t.headImg){var n=t.headImg,a=void 0===n?"https://pic8.58cdn.com.cn/bizmp/n_v285d6a16d725a446694db35df23c9db24.png?w=72&h=72":n;a=this.tempLogo||a,a.indexOf("http")<0&&a.indexOf("file:")<0&&(a=(0,_utils.picSrcDomain)()+a+"?w=72&h=72"),this.logoUrl=a}void 0!==t.addressLatitude&&""===t.addressLatitude&&(delete t.addressLatitude,delete t.addressLongitude),this.form=Object.assign({},r,_extends({},t)),this.$apply()}},{key:"getProvinces",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n,a,i,s,o,u,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,_ajaxP.get)(provinceApi);case 2:if(t=e.sent,r=_slicedToArray(t,2),n=r[0],a=r[1],!n){e.next=9;break}return this.toast(n),e.abrupt("return");case 9:return i=this.form.province||"5001",e.next=12,(0,_ajaxP.get)(cityApi+i);case 12:if(s=e.sent,o=_slicedToArray(s,2),u=o[0],c=o[1],!u){e.next=19;break}return this.toast(u),e.abrupt("return");case 19:console.log("provinces",a,"citys",c),this.areas=[a,c],this.loading=!1,this.$apply();case 23:case"end":return e.stop()}},e,this)}));return e}()},{key:"getLocation",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_wepy2.default.getLocation({type:"wgs84"});case 2:if(t=e.sent,r=t.latitude,n=t.longitude,!this.form.addressLatitude){e.next=7;break}return e.abrupt("return");case 7:this.updateForm({addressLatitude:r,addressLongitude:n});case 8:case"end":return e.stop()}},e,this)}));return e}()},{key:"getAppInfo",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,n,a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,_ajaxP.get)(appinfoApi+"/"+t);case 2:if(r=e.sent,n=_slicedToArray(r,2),a=n[0],i=n[1],!a){e.next=9;break}return this.toast(a),e.abrupt("return");case 9:this.updateForm(_extends({},i));case 10:case"end":return e.stop()}},e,this)}));return e}()},{key:"toast",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];var n=t[0],a=t[1],i=void 0===a?2e3:a;return _wepy2.default.showToast({title:n,icon:"none",duration:i})}},{key:"verify",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=/^1[3456789][0-9]{9}$/,r=this.data.form,r.headImg){e.next=5;break}return this.toast("请完善信息"),e.abrupt("return",!1);case 5:if(r.nickName){e.next=8;break}return this.toast("输入小程序名称"),e.abrupt("return",!1);case 8:if(!(r.nickName.length<4)){e.next=11;break}return this.toast("小程序名称不得小于4个"),e.abrupt("return",!1);case 11:if(r.telphone){e.next=14;break}return this.toast("输入联系电话"),e.abrupt("return",!1);case 14:if(!(r.telphone.length<11)||t.test(r.telphone)){e.next=18;break}return e.next=17,(0,_utils.toastSync)("手机号不正确");case 17:return e.abrupt("return",!1);case 18:if(r.city){e.next=21;break}return this.toast("选择城市"),e.abrupt("return",!1);case 21:if(r.address){e.next=24;break}return this.toast("输入详情地址"),e.abrupt("return",!1);case 24:return e.abrupt("return",!0);case 25:case"end":return e.stop()}},e,this)}));return e}()},{key:"onLoad",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.mpid||_wepy2.default.getStorageSync("current_mpid"),r||_wepy2.default.navigateBack(),this.mpid=r,e.next=5,this.getAppInfo(this.mpid);case 5:return e.next=7,this.getLocation();case 7:return e.next=9,this.getProvinces();case 9:this.defaultSelCityIndex();case 10:case"end":return e.stop()}},e,this)}));return e}()}]),t}(_wepy2.default.page);Page(require("./../npm/wepy/lib/wepy.js").default.$createPage(AppEdit,"pages/AppEdit"));