"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,n){function r(a,o){try{var i=t[a](o),u=i.value}catch(e){return void n(e)}if(!i.done)return Promise.resolve(u).then(function(e){r("next",e)},function(e){r("throw",e)});e(u)}return r("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _slicedToArray=function(){function e(e,t){var n=[],r=!0,a=!1,o=void 0;try{for(var i,u=e[Symbol.iterator]();!(r=(i=u.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){a=!0,o=e}finally{try{!r&&u.return&&u.return()}finally{if(a)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),_utils=require("./../utils/index.js"),host="https://yaofa.58.com",Uploader=function(e){function t(){var e,n,r,a;_classCallCheck(this,t);for(var o=arguments.length,i=Array(o),u=0;u<o;u++)i[u]=arguments[u];return n=r=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(i))),r.data={uploading:!1,vm:[],images:[],titleStatus:["图片","视频"]},r.props={uploadtype:String,maxSize:String,maxCount:String,showDelete:{type:Boolean,default:!0},uploadingImage:{type:String,default:"https://img.58cdn.com.cn/lbg/shangjiaxcxht/zhushou/img/upimg_loading_1.gif"},uploadImageApi:{type:String,default:"/fileUpload"},uploadVideoApi:{type:String,default:"/wosFileUpload"}},r.computed={currentCount:function(){var e=this.maxCount-this.vm.length;return e>0?e:0}},r.methods={bindUploadImage:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r,a,o,i,u,s=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.uploading){e.next=2;break}return e.abrupt("return");case 2:return t=this,n=this.data.vm.length||0,e.next=6,_wepy2.default.chooseImage({count:this.currentCount,sizeType:"compressed"});case 6:r=e.sent,a=r.tempFilePaths,o=a.length,i=[].concat(_toConsumableArray(t.vm)),u=[].concat(_toConsumableArray(t.images)),i=t.batchAddArray(i,o,t.uploadingImage),t.uploading=!0,t.vm=[].concat(_toConsumableArray(i)),t.$emit("changeimages",{uploading:t.uploading,images:t.images}),t.vm=[].concat(_toConsumableArray(i)),t.$apply(),a.map(function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,a){var c,l,p,m;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.uploadImage(r);case 2:if(c=e.sent,l=_slicedToArray(c,2),p=l[0],m=l[1],!p){e.next=12;break}return e.next=9,(0,_utils.toastSync)(p);case 9:i.splice(n+a,1),e.next=14;break;case 12:i.splice(n+a,1,r),u.push(m.content);case 14:return t.images=[].concat(_toConsumableArray(u)),t.vm=[].concat(_toConsumableArray(i)),o-1===a&&t.$emit("changeimages",{uploading:!1,images:t.images}),t.$apply(),e.abrupt("return",r);case 19:case"end":return e.stop()}},e,s)}));return function(t,n){return e.apply(this,arguments)}}());case 18:case"end":return e.stop()}},e,this)}));return e}(),bindUploadVideo:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,n,r,a,o,i,u,s,c=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.uploading){e.next=2;break}return e.abrupt("return");case 2:return t=this,n=this.data.vm.length||0,e.next=6,_wepy2.default.chooseVideo();case 6:r=e.sent,a=r.tempFilePath,o=[a],a=null,console.log(o),i=o.length,u=[].concat(_toConsumableArray(t.vm)),s=[].concat(_toConsumableArray(t.images)),u=t.batchAddArray(u,i,t.uploadingImage),t.uploading=!0,t.vm=[].concat(_toConsumableArray(u)),t.$emit("changeimages",{uploading:t.uploading,images:t.images}),t.vm=[].concat(_toConsumableArray(u)),t.$apply(),o.map(function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,a){var o,l,p,m;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.uploadVideo(r);case 2:if(o=e.sent,l=_slicedToArray(o,2),p=l[0],m=l[1],!p){e.next=12;break}return e.next=9,(0,_utils.toastSync)(p);case 9:u.splice(n+a,1),e.next=14;break;case 12:u.splice(n+a,1,r),s.push(m.content);case 14:return t.images=[].concat(_toConsumableArray(s)),t.vm=[].concat(_toConsumableArray(u)),t.$emit("changeimages",{uploading:!1,images:t.images}),t.$apply(),i-1===a&&(t.uploading=!1,t.$apply()),e.abrupt("return",r);case 20:case"end":return e.stop()}},e,c)}));return function(t,n){return e.apply(this,arguments)}}());case 21:case"end":return e.stop()}},e,this)}));return e}(),onCancelImage:function(e){if(!this.data.uploading){var t=this.data.vm,n=this.data.images;t.splice(e,1),n.splice(e,1),this.vm=[].concat(_toConsumableArray(t)),this.images=[].concat(_toConsumableArray(n)),this.$apply(),this.$emit("changeImages",{images:this.data.images})}},bindPlayVideo:function(e){e&&_wepy2.default.navigateTo({url:"/pages/VideoPlay?url="+e})},bindPreviewImage:function(e){_wepy2.default.previewImage({current:e,urls:this.vm})}},a=n,_possibleConstructorReturn(r,a)}return _inherits(t,e),_createClass(t,[{key:"uploadImage",value:function(e){var t=this;return new Promise(function(n){_wepy2.default.uploadFile({url:host+t.uploadImageApi,filePath:e,name:"content"}).then(function(e){try{console.log(e);var t=JSON.parse(e.data),r=t.state,a=t.msg,o=t.data;n(100===r?[null,o]:[a]),console.log(t)}catch(e){console.log(e),n([e])}}).catch(function(e){console.log(e);var t=e.errMsg;n([t])})})}},{key:"uploadVideo",value:function(e){var t=this;return new Promise(function(n){_wepy2.default.uploadFile({url:host+t.uploadVideoApi,filePath:e,name:"content"}).then(function(e){try{console.log(e);var t=JSON.parse(e.data),r=t.state,a=t.msg,o=t.data;n(100===r?[null,o]:[a]),console.log(t)}catch(e){console.log(e),n([e])}}).catch(function(e){console.log(e);var t=e.errMsg;n([t])})})}},{key:"batchAddArray",value:function(e,t,n){var r=e;if(r instanceof Array)for(var a=0;a<t;a+=1)r.push(n);return r}},{key:"onLoad",value:function(){this.vm=[],this.images=[],this.uploading=!1,this.$apply()}}]),t}(_wepy2.default.component);exports.default=Uploader;