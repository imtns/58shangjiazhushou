"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(exports,"__esModule",{value:!0});var _slicedToArray=function(){function t(t,e){var i=[],a=!0,r=!1,n=void 0;try{for(var o,c=t[Symbol.iterator]();!(a=(o=c.next()).done)&&(i.push(o.value),!e||i.length!==e);a=!0);}catch(t){r=!0,n=t}finally{try{!a&&c.return&&c.return()}finally{if(r)throw n}}return i}return function(e,i){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,i,a){return i&&t(e.prototype,i),a&&t(e,a),e}}(),_wepy=require("./../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),windowWRPX=750,pageX=0,pageY=0,_wx$getSystemInfoSync=wx.getSystemInfoSync(),pixelRatio=_wx$getSystemInfoSync.pixelRatio,sizeConfPageX=0,sizeConfPageY=0,initDragCutW=0,initDragCutL=0,initDragCutH=0,initDragCutT=0,dragScaleP=2,ctx=null,cutCoefficient=.8,originSrc="",drawL=0,drawT=0,Cropper=function(t){function e(){var t,i,a,r;_classCallCheck(this,e);for(var n=arguments.length,o=Array(n),c=0;c<n;c++)o[c]=arguments[c];return i=a=_possibleConstructorReturn(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this].concat(o))),a.data={imageSrc:"",isShowImg:!1,ratio:"",cutRatio:"",canvasWidth:windowWRPX,cropperInitW:windowWRPX,cropperInitH:windowWRPX,cropperW:windowWRPX,cropperH:windowWRPX,cropperL:0,cropperT:0,scaleP:0,imageW:0,imageH:0,cutW:0,cutH:0,cutL:0,cutT:0,qualityWidth:720,innerAspectRadio:1},a.events={"crop-loadImage":function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=this,r=a.qualityWidth,n=a.innerAspectRadio,o=null;a.imageSrc=t,a.ratio=e,!0===i&&(originSrc=t),wx.showLoading({title:"图片加载中..."}),wx.getImageInfo({src:t,success:function(i){n=i.width/i.height;var c=Math.max(r,r/n);if(a.canvasWidth=c,"string"==typeof e&&e){var u=e.split(","),s=_slicedToArray(u,2),p=s[0],g=s[1];o=+p/+g}else o=n;if(a.cutRatio=o,n>=1){a.cropperW=windowWRPX,a.cropperH=windowWRPX/n,a.cropperL=Math.ceil((windowWRPX-windowWRPX)/2),a.cropperT=Math.ceil((windowWRPX-windowWRPX/n)/2);var h=windowWRPX*cutCoefficient,l=windowWRPX*cutCoefficient/o;a.cutW=h,a.cutH=l,a.cutL=Math.ceil((windowWRPX-windowWRPX*cutCoefficient)/2),a.cutT=(windowWRPX/n-windowWRPX*cutCoefficient/o)/2,a.scaleP=i.width*pixelRatio/windowWRPX,a.imageW=i.width*pixelRatio,a.imageH=i.height*pixelRatio,a.innerAspectRadio=n,a.cropperInitH=1206,drawT=(c-r/n)/2}else a.cropperW=windowWRPX*n,a.cropperH=windowWRPX,a.cropperL=Math.ceil((windowWRPX-windowWRPX*n)/2),a.cropperT=Math.ceil((windowWRPX/n-windowWRPX)/2),a.cutW=windowWRPX*cutCoefficient*n,a.cutH=windowWRPX*cutCoefficient*n/o,a.cutL=(windowWRPX*n-windowWRPX*cutCoefficient*n)/2,a.cutT=(windowWRPX-windowWRPX*cutCoefficient*n/o)/2,a.scaleP=i.width*pixelRatio/windowWRPX,a.imageW=i.width*pixelRatio,a.imageH=i.height*pixelRatio,a.innerAspectRadio=n,a.cropperInitH=a.cropperInitW/n,drawL=(c-r)/2;a.isShowImg=!0,ctx.drawImage(t,0,0,r,r/n),ctx.draw(),a.innerAspectRadio=n,a.$apply(),wx.hideLoading()}})}},a.methods={cancel:function(){this.closeCrop()},restore:function(){this.$emit("crop-loadImage",originSrc,this.ratio,!1)},contentStartMove:function(t){var e=_slicedToArray(t.touches,1),i=e[0];pageX=i.pageX,pageY=i.pageY},contentMoveing:function(t){var e=(pageX-t.touches[0].pageX)*dragScaleP,i=(pageY-t.touches[0].pageY)*dragScaleP,a=Math.max(this.cutL-e,0),r=Math.max(this.cutT-i,0),n=this.cropperW-this.cutW,o=this.cropperH-this.cutH;this.cutL=Math.min(n,a),this.cutT=Math.min(o,r),this.$apply();var c=_slicedToArray(t.touches,1),u=c[0];pageX=u.pageX,pageY=u.pageY},dragStart:function(t){sizeConfPageX=t.touches[0].pageX,sizeConfPageY=t.touches[0].pageY,initDragCutW=this.cutW,initDragCutL=this.cutL,initDragCutT=this.cutT,initDragCutH=this.cutH},dragMove:function(t){var e=this,i=t.target.dataset.drag,a=e.cutRatio,r=e.ratio;if(!~["right","left","top","bottom"].indexOf(i)){var n=void 0;switch(i){case"right":if(n=(sizeConfPageX-t.touches[0].pageX)*dragScaleP,initDragCutW>=n){if(n<0&&e.cropperW>initDragCutL+e.cutW&&(this.cutW=initDragCutW-n),!(n>0))return;this.cutW=initDragCutW-n,this.$apply()}break;case"left":if(n=(n=sizeConfPageX-t.touches[0].pageX)*dragScaleP,initDragCutW>=n&&initDragCutL>n){if(n<0&&Math.abs(n)>=initDragCutW)return;this.cutL=initDragCutL-n,this.cutW=initDragCutW+n,this.$apply()}break;case"top":if(n=(sizeConfPageY-t.touches[0].pageY)*dragScaleP,initDragCutH>=n&&initDragCutT>n){if(n<0&&Math.abs(n)>=initDragCutH)return;this.cutT=initDragCutT-n,this.cutH=initDragCutH+n,this.$apply()}break;case"bottom":if(n=(sizeConfPageY-t.touches[0].pageY)*dragScaleP,initDragCutH>=n){if(n<0&&e.cropperH>initDragCutT+e.cutH&&(this.cutH=initDragCutH-n),!(n>0))return;this.cutH=initDragCutH-n,this.$apply()}break;case"rightBottom":var o=(sizeConfPageX-t.touches[0].pageX)*dragScaleP,c=(sizeConfPageY-t.touches[0].pageY)*dragScaleP;if(initDragCutH>=c&&initDragCutW>=o){if((c<0&&e.cropperH>initDragCutT+e.cutH||c>0)&&(this.cutH=initDragCutH-c,r&&(this.cutW=(initDragCutH-c)*a)),!(o<0&&e.cropperW>initDragCutL+e.cutW||o>0))return;this.cutW=initDragCutW-o,r&&(this.cutH=(initDragCutW-o)/a),this.$apply()}}}},rotateImage:function(){var t=this,e=t.qualityWidth,i=t.innerAspectRadio,a=e/2,r=e/i/2,n=wx.createCanvasContext("myCanvas2");wx.showLoading({title:"图片加载中..."}),n.save(),n.translate(a,r),n.rotate(90*Math.PI/180),n.translate(-a,-r);var o=drawT;drawT=drawL,drawL=o,n.drawImage(t.imageSrc,drawL,-drawT,e,e/i),n.draw(!1,function(){wx.canvasToTempFilePath({x:drawL,y:drawT,width:e/i,height:e,quality:1,canvasId:"myCanvas2",success:function(a){t.qualityWidth=e/i,t.$apply(),t.$emit("crop-loadImage",a.tempFilePath,t.ratio,!1)}})})},getImageInfo:function(){var t=this,e=t.qualityWidth,i=t.innerAspectRadio;wx.showLoading({title:"图片生成中..."}),ctx.draw(!0,function(){var a=t.cutW/t.cropperW*e,r=t.cutH/t.cropperH*e/i,n=t.cutL/t.cropperW*e,o=t.cutT/t.cropperH*e/i;wx.canvasToTempFilePath({x:n,y:o,width:a,height:r,destWidth:a,destHeight:r,quality:.5,canvasId:"myCanvas",success:function(e){wx.hideLoading(),t.$emit("after-crop",e.tempFilePath),t.closeCrop(),wx.previewImage({current:"",urls:[e.tempFilePath]})}})})}},r=i,_possibleConstructorReturn(a,r)}return _inherits(e,t),_createClass(e,[{key:"onLoad",value:function(){ctx=wx.createCanvasContext("myCanvas")}},{key:"closeCrop",value:function(){this.imageSrc="",this.isShowImg=!1,this.$apply()}}]),e}(_wepy2.default.component);exports.default=Cropper;