"use strict";var app=getApp(),_require=require("./../../../utils/index.js"),toast=_require.toast,alert=_require.alert,_require2=require("./../../../utils/http.js"),get=_require2.get,post=_require2.post,_require3=require("./../../../utils/ajax.js"),ajax=_require3.ajax,_require4=require("./../../../utils/event.js"),bindEvent=_require4.bindEvent,emitEvent=_require4.emitEvent;Component({externalClasses:["my-class"],properties:{openType:{type:String,value:""},url:{type:String,value:""}},methods:{bindGetUserInfo:function(e){var t=this;if("getUserInfo:ok"==e.detail.errMsg){var n=e.detail,i=n.userInfo,o=(n.rawData,n.signature,n.encryptedData),r=n.iv;this.regist({iv:r,encryptedData:o},function(e,n){if(e)return void alert(e);emitEvent("consumerRegister",i),Object.assign(app.globalData,{userInfo:i}),t.doCallback()})}else console.log(e.detail.errMsg),alert("由于您拒绝了授权，后续功能不能使用。")},doCallback:function(){var e=this.data,t=e.openType,n=e.url,i=e.consumerId;if(!n)return void this.triggerEvent("consumersubmit",{consumerId:i});"switchTab"==t?wx.switchTab({url:n}):wx.navigateTo({url:n})},setLoginStatus:function(e){Object.assign(app.globalData,{logining:e})},getConsumerId:function(e){var t=this,n=app.globalData,i=n.consumerId,o=n.logining,r=void 0!==o&&o;if(i)return void e(null,i);r||(t.setLoginStatus(!0),this.getCode(function(n,i){return n?(t.setLoginStatus(!1),void(e&&e(n))):app.globalData.env58?void ajax("/wechat/getSession/",{code:i},function(n,i){if(t.setLoginStatus(!1),n)return void e(n);var o=i.data,r=(o.openid,o.session);app.globalData.consumerId=r,e(null,r)}):void get("/wechat/getSession/",{code:i},function(n,i){if(t.setLoginStatus(!1),n)return void e(n);var o=(i.openid,i.session);app.globalData.consumerId=o,e(null,o)})}))},getCode:function(e){wx.login({success:function(t){e(null,t.code)},fail:function(t){console.log("wx.login 接口调用失败，将无法正常使用开放接口等服务",t),e(t)}})},regist:function(e,t){var n=Object.assign({},e,{session:this.data.consumerId});post("/wechat/decodeUserInfo/",n,function(e,n){console.log(e,n),e?t&&t(e):t&&t(null,n)})}},attached:function(){var e=app.globalData,t=e.consumerId,n=void 0===t?0:t,i=e.userInfo,o=void 0===i?0:i;this.setData({consumerId:n,userInfo:o});var r=this;bindEvent("consumerLogin",function(e){r.setData({consumerId:e})}),bindEvent("consumerRegister",function(e){r.setData({userInfo:e})}),this.getConsumerId(function(e,t){if(e)return void toast(e);emitEvent("consumerLogin",t)})}});