'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.moduleCfgParse = exports.moduleDataParse = undefined;

var _index = require('./index.js');

var moduleDataParse = exports.moduleDataParse = function moduleDataParse(name) {
    var modData = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : { data: [] };

    if (~['services', 'serviceOther'].indexOf(name)) {
        if (modData.data && modData.data.length > 0) {
            modData.data.forEach(function (service) {
                service.img = (0, _index.picSrcDomain)() + service.img;
            });
        } else {
            modData = Object.assign({}, {
                page: 0,
                size: 0,
                total: 0,
                data: []
            }, modData);
        }
    }

    if (name === 'coupon') {
        if (!modData.data) {
            modData.data = [];
        } else {
            var _loop = function _loop(i) {
                var couponCondition = JSON.parse(modData.data[i].couponCondition);
                Object.keys(couponCondition).forEach(function (key) {
                    modData.data[i][key] = couponCondition[key];
                });
            };

            for (var i = 0; i < modData.data.length; i += 1) {
                _loop(i);
            }
        }
    }

    if (name === 'article') {
        if (modData.data.length > 0) {
            modData.data.forEach(function (art) {
                art.cover = (0, _index.picSrcDomain)() + art.cover;
            });
        }
    }

    if (name === 'order') {
        if (modData.data.length > 0) {
            modData.data.forEach(function (order) {
                order.pics = (0, _index.picSrcDomain)() + order.pics;
            });
        }
    }
    if (typeof modData.data === 'undefined' || modData.data === null) {
        Object.assign(modData, { data: [] });
    }
    return modData;
};

var moduleCfgParse = exports.moduleCfgParse = function moduleCfgParse(name, cfgObj) {
    var cfg = typeof cfgObj === 'string' ? JSON.parse(cfgObj) : cfgObj;

    if (~['images', 'imageSwiper', 'banner'].indexOf(name)) {
        cfg.images = cfg.images ? cfg.images : [];
        if (cfg.images.length > 0) {
            cfg.images = cfg.images.filter(function (img) {
                img.fullPath = (0, _index.picSrcDomain)() + img.src;
                return img.src;
            });
        }
        if (cfg.images.length === 0) {
            cfg.images.push({
                fullPath: '//pic8.58cdn.com.cn/bizmp/n_v285d6a16d725a446694db35df23c9db24.png'
            });
        }
    }
    if (name === 'images') {
        var imagesTheme = [{ theme: '1', showSize: '2', title: '一行1张显示' }, { theme: '2', showSize: '4', title: '一行2张显示' }, { theme: '3', showSize: '6', title: '一行3张显示' }, { theme: '4', showSize: '3', title: '1左2右显示' }, { theme: '5', showSize: '3', title: '1上2下显示' }, { theme: '6', showSize: '4', title: '1上3下显示' }, { theme: '7', showSize: '4', title: '一行4张显示' }, { theme: '8', showSize: '2', title: '双图' }];
        cfg.theme = cfg.theme ? cfg.theme.toString() : '1';
        cfg.showSize = imagesTheme[cfg.theme - 1].showSize || 4;
    }

    return cfg;
};

// const emptyFilter = (mods) => {
//     const modM = mods.filter((mod) => {
//         let isEmpty = false;
//         switch (mod.name) {
//             case 'video':
//                 if (!mod.data.length) {
//                     isEmpty = true;
//                 }
//                 break;
//             case 'services':
//                 if (!mod.data.data.length) {
//                     isEmpty = true;
//                 }
//                 break;
//             default:
//                 break;
//         }
//         return !isEmpty;
//     });
//     return modM;
// };

exports.default = {
    parsePageData: function parsePageData(pageData) {
        var mods = pageData.map(function (mod) {
            var cfgTemp = {};
            var paramsTemp = {};
            try {
                cfgTemp = mod.props.cfg || {};
                paramsTemp = mod.params ? JSON.parse(mod.params) : {};
            } catch (e) {
                console.log('json error\n', mod.props.cfg, 'params error\n', mod.params);
            }
            mod.cfg = cfgTemp;
            mod.params = paramsTemp;

            var name = mod.name,
                cfg = mod.cfg,
                title = mod.cfg.title;


            cfg.title = title || name;

            // data 修改
            // const modData = mod.props.data[name] || {};
            // mod.data = moduleDataParse(name, modData);

            // cfg 修改
            // 特定配置处理
            // images 模块的url处理
            moduleCfgParse(name, cfg);

            return mod;
        });
        return mods;
    },
    show: function show(pageData) {
        var modules = pageData.modules;

        if (!modules) return [];
        var mods = modules.map(function (mod) {
            var cfgTemp = {};
            var paramsTemp = {};
            try {
                cfgTemp = mod.cfg ? JSON.parse(mod.cfg) : {};
                paramsTemp = mod.params ? JSON.parse(mod.params) : {};
            } catch (e) {
                console.log('json error\n', mod.cfg, 'params error\n', mod.params);
            }
            mod.cfg = cfgTemp;
            mod.params = paramsTemp;

            var name = mod.name,
                cfg = mod.cfg,
                title = mod.cfg.title;


            cfg.title = title || name;

            // data 修改
            var modData = mod.data[name] || {};
            mod.data = moduleDataParse(name, modData);

            // cfg 修改
            // 特定配置处理
            // images 模块的url处理
            moduleCfgParse(name, cfg);

            return mod;
        });
        // m版本优享小程序 数据为空的时候特殊处理不显示
        // if (globalData.mVerison) {
        //     const modsM = emptyFilter(mods);
        //     return modsM;
        // }
        return mods;
    },
    save: function save(modData) {
        var mods = modData.map(function (mod) {
            var name = mod.name,
                cfg = mod.cfg;

            if (~['images', 'imageSwiper', 'banner'].indexOf(name)) {
                cfg.images = cfg.images || [];
                cfg.images = cfg.images.filter(function (img) {
                    return img.src;
                }).map(function (img) {
                    delete img.fullPath;
                    return img;
                });
            }
            return mod;
        });

        return mods;
    }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXNQYXJzZS5qcyJdLCJuYW1lcyI6WyJtb2R1bGVEYXRhUGFyc2UiLCJuYW1lIiwibW9kRGF0YSIsImRhdGEiLCJpbmRleE9mIiwibGVuZ3RoIiwiZm9yRWFjaCIsInNlcnZpY2UiLCJpbWciLCJPYmplY3QiLCJhc3NpZ24iLCJwYWdlIiwic2l6ZSIsInRvdGFsIiwiaSIsImNvdXBvbkNvbmRpdGlvbiIsIkpTT04iLCJwYXJzZSIsImtleXMiLCJrZXkiLCJhcnQiLCJjb3ZlciIsIm9yZGVyIiwicGljcyIsIm1vZHVsZUNmZ1BhcnNlIiwiY2ZnT2JqIiwiY2ZnIiwiaW1hZ2VzIiwiZmlsdGVyIiwiZnVsbFBhdGgiLCJzcmMiLCJwdXNoIiwiaW1hZ2VzVGhlbWUiLCJ0aGVtZSIsInNob3dTaXplIiwidGl0bGUiLCJ0b1N0cmluZyIsInBhcnNlUGFnZURhdGEiLCJwYWdlRGF0YSIsIm1vZHMiLCJtYXAiLCJtb2QiLCJjZmdUZW1wIiwicGFyYW1zVGVtcCIsInByb3BzIiwicGFyYW1zIiwiZSIsImNvbnNvbGUiLCJsb2ciLCJzaG93IiwibW9kdWxlcyIsInNhdmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFFTyxJQUFNQSw0Q0FBa0IsU0FBbEJBLGVBQWtCLENBQUNDLElBQUQsRUFBa0M7QUFBQSxRQUEzQkMsT0FBMkIsdUVBQWpCLEVBQUVDLE1BQU0sRUFBUixFQUFpQjs7QUFDN0QsUUFBSSxDQUFDLENBQUMsVUFBRCxFQUFhLGNBQWIsRUFBNkJDLE9BQTdCLENBQXFDSCxJQUFyQyxDQUFMLEVBQWlEO0FBQzdDLFlBQUlDLFFBQVFDLElBQVIsSUFBZ0JELFFBQVFDLElBQVIsQ0FBYUUsTUFBYixHQUFzQixDQUExQyxFQUE2QztBQUN6Q0gsb0JBQVFDLElBQVIsQ0FBYUcsT0FBYixDQUFxQixVQUFDQyxPQUFELEVBQWE7QUFDOUJBLHdCQUFRQyxHQUFSLEdBQWMsNkJBQWlCRCxRQUFRQyxHQUF2QztBQUNILGFBRkQ7QUFHSCxTQUpELE1BSU87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QUFTO0FBQUEsZ0JBQ3RCeEMsSUFEc0IsR0FDUndDLEdBRFEsQ0FDdEJ4QyxJQURzQjtBQUFBLGdCQUNoQnlCLEdBRGdCLEdBQ1JlLEdBRFEsQ0FDaEJmLEdBRGdCOztBQUU5QixnQkFBSSxDQUFDLENBQUMsUUFBRCxFQUFXLGFBQVgsRUFBMEIsUUFBMUIsRUFBb0N0QixPQUFwQyxDQUE0Q0gsSUFBNUMsQ0FBTCxFQUF3RDtBQUNwRHlCLG9CQUFJQyxNQUFKLEdBQWFELElBQUlDLE1BQUosSUFBYyxFQUEzQjtBQUNBRCxvQkFBSUMsTUFBSixHQUFhRCxJQUFJQyxNQUFKLENBQVdDLE1BQVgsQ0FBa0I7QUFBQSwyQkFBT3BCLElBQUlzQixHQUFYO0FBQUEsaUJBQWxCLEVBQWtDVSxHQUFsQyxDQUFzQyxVQUFDaEMsR0FBRCxFQUFTO0FBQ3hELDJCQUFPQSxJQUFJcUIsUUFBWDtBQUNBLDJCQUFPckIsR0FBUDtBQUNILGlCQUhZLENBQWI7QUFJSDtBQUNELG1CQUFPaUMsR0FBUDtBQUNILFNBVlksQ0FBYjs7QUFZQSxlQUFPRixJQUFQO0FBQ0g7QUFsRlUsQyIsImZpbGUiOiJtb2R1bGVzUGFyc2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBwaWNTcmNEb21haW4gfSBmcm9tICcuL2luZGV4JztcblxuZXhwb3J0IGNvbnN0IG1vZHVsZURhdGFQYXJzZSA9IChuYW1lLCBtb2REYXRhID0geyBkYXRhOiBbXSB9KSA9PiB7XG4gICAgaWYgKH5bJ3NlcnZpY2VzJywgJ3NlcnZpY2VPdGhlciddLmluZGV4T2YobmFtZSkpIHtcbiAgICAgICAgaWYgKG1vZERhdGEuZGF0YSAmJiBtb2REYXRhLmRhdGEubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgbW9kRGF0YS5kYXRhLmZvckVhY2goKHNlcnZpY2UpID0+IHtcbiAgICAgICAgICAgICAgICBzZXJ2aWNlLmltZyA9IHBpY1NyY0RvbWFpbigpICsgc2VydmljZS5pbWc7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG1vZERhdGEgPSBPYmplY3QuYXNzaWduKHt9LCB7XG4gICAgICAgICAgICAgICAgcGFnZTogMCxcbiAgICAgICAgICAgICAgICBzaXplOiAwLFxuICAgICAgICAgICAgICAgIHRvdGFsOiAwLFxuICAgICAgICAgICAgICAgIGRhdGE6IFtdLFxuICAgICAgICAgICAgfSwgbW9kRGF0YSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAobmFtZSA9PT0gJ2NvdXBvbicpIHtcbiAgICAgICAgaWYgKCFtb2REYXRhLmRhdGEpIHtcbiAgICAgICAgICAgIG1vZERhdGEuZGF0YSA9IFtdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtb2REYXRhLmRhdGEubGVuZ3RoOyBpICs9IDEpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb3Vwb25Db25kaXRpb24gPSBKU09OLnBhcnNlKG1vZERhdGEuZGF0YVtpXS5jb3Vwb25Db25kaXRpb24pO1xuICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKGNvdXBvbkNvbmRpdGlvbikuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIG1vZERhdGEuZGF0YVtpXVtrZXldID0gY291cG9uQ29uZGl0aW9uW2tleV07XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAobmFtZSA9PT0gJ2FydGljbGUnKSB7XG4gICAgICAgIGlmIChtb2REYXRhLmRhdGEubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgbW9kRGF0YS5kYXRhLmZvckVhY2goKGFydCkgPT4ge1xuICAgICAgICAgICAgICAgIGFydC5jb3ZlciA9IHBpY1NyY0RvbWFpbigpICsgYXJ0LmNvdmVyO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAobmFtZSA9PT0gJ29yZGVyJykge1xuICAgICAgICBpZiAobW9kRGF0YS5kYXRhLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIG1vZERhdGEuZGF0YS5mb3JFYWNoKChvcmRlcikgPT4ge1xuICAgICAgICAgICAgICAgIG9yZGVyLnBpY3MgPSBwaWNTcmNEb21haW4oKSArIG9yZGVyLnBpY3M7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAodHlwZW9mIChtb2REYXRhLmRhdGEpID09PSAndW5kZWZpbmVkJyB8fCBtb2REYXRhLmRhdGEgPT09IG51bGwpIHtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihtb2REYXRhLCB7IGRhdGE6IFtdIH0pO1xuICAgIH1cbiAgICByZXR1cm4gbW9kRGF0YTtcbn07XG5cblxuZXhwb3J0IGNvbnN0IG1vZHVsZUNmZ1BhcnNlID0gKG5hbWUsIGNmZ09iaikgPT4ge1xuICAgIGNvbnN0IGNmZyA9IHR5cGVvZiBjZmdPYmogPT09ICdzdHJpbmcnID8gSlNPTi5wYXJzZShjZmdPYmopIDogY2ZnT2JqO1xuXG4gICAgaWYgKH5bJ2ltYWdlcycsICdpbWFnZVN3aXBlcicsICdiYW5uZXInXS5pbmRleE9mKG5hbWUpKSB7XG4gICAgICAgIGNmZy5pbWFnZXMgPSBjZmcuaW1hZ2VzID8gY2ZnLmltYWdlcyA6IFtdO1xuICAgICAgICBpZiAoY2ZnLmltYWdlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjZmcuaW1hZ2VzID0gY2ZnLmltYWdlcy5maWx0ZXIoKGltZykgPT4ge1xuICAgICAgICAgICAgICAgIGltZy5mdWxsUGF0aCA9IHBpY1NyY0RvbWFpbigpICsgaW1nLnNyYztcbiAgICAgICAgICAgICAgICByZXR1cm4gaW1nLnNyYztcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjZmcuaW1hZ2VzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgY2ZnLmltYWdlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICBmdWxsUGF0aDogJy8vcGljOC41OGNkbi5jb20uY24vYml6bXAvbl92Mjg1ZDZhMTZkNzI1YTQ0NjY5NGRiMzVkZjIzYzlkYjI0LnBuZycsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAobmFtZSA9PT0gJ2ltYWdlcycpIHtcbiAgICAgICAgY29uc3QgaW1hZ2VzVGhlbWUgPSBbXG4gICAgICAgICAgICB7IHRoZW1lOiAnMScsIHNob3dTaXplOiAnMicsIHRpdGxlOiAn5LiA6KGMMeW8oOaYvuekuicgfSxcbiAgICAgICAgICAgIHsgdGhlbWU6ICcyJywgc2hvd1NpemU6ICc0JywgdGl0bGU6ICfkuIDooYwy5byg5pi+56S6JyB9LFxuICAgICAgICAgICAgeyB0aGVtZTogJzMnLCBzaG93U2l6ZTogJzYnLCB0aXRsZTogJ+S4gOihjDPlvKDmmL7npLonIH0sXG4gICAgICAgICAgICB7IHRoZW1lOiAnNCcsIHNob3dTaXplOiAnMycsIHRpdGxlOiAnMeW3pjLlj7PmmL7npLonIH0sXG4gICAgICAgICAgICB7IHRoZW1lOiAnNScsIHNob3dTaXplOiAnMycsIHRpdGxlOiAnMeS4ijLkuIvmmL7npLonIH0sXG4gICAgICAgICAgICB7IHRoZW1lOiAnNicsIHNob3dTaXplOiAnNCcsIHRpdGxlOiAnMeS4ijPkuIvmmL7npLonIH0sXG4gICAgICAgICAgICB7IHRoZW1lOiAnNycsIHNob3dTaXplOiAnNCcsIHRpdGxlOiAn5LiA6KGMNOW8oOaYvuekuicgfSxcbiAgICAgICAgICAgIHsgdGhlbWU6ICc4Jywgc2hvd1NpemU6ICcyJywgdGl0bGU6ICflj4zlm74nIH0sXG4gICAgICAgIF07XG4gICAgICAgIGNmZy50aGVtZSA9IGNmZy50aGVtZSA/IGNmZy50aGVtZS50b1N0cmluZygpIDogJzEnO1xuICAgICAgICBjZmcuc2hvd1NpemUgPSBpbWFnZXNUaGVtZVtjZmcudGhlbWUgLSAxXS5zaG93U2l6ZSB8fCA0O1xuICAgIH1cblxuICAgIHJldHVybiBjZmc7XG59O1xuXG4vLyBjb25zdCBlbXB0eUZpbHRlciA9IChtb2RzKSA9PiB7XG4vLyAgICAgY29uc3QgbW9kTSA9IG1vZHMuZmlsdGVyKChtb2QpID0+IHtcbi8vICAgICAgICAgbGV0IGlzRW1wdHkgPSBmYWxzZTtcbi8vICAgICAgICAgc3dpdGNoIChtb2QubmFtZSkge1xuLy8gICAgICAgICAgICAgY2FzZSAndmlkZW8nOlxuLy8gICAgICAgICAgICAgICAgIGlmICghbW9kLmRhdGEubGVuZ3RoKSB7XG4vLyAgICAgICAgICAgICAgICAgICAgIGlzRW1wdHkgPSB0cnVlO1xuLy8gICAgICAgICAgICAgICAgIH1cbi8vICAgICAgICAgICAgICAgICBicmVhaztcbi8vICAgICAgICAgICAgIGNhc2UgJ3NlcnZpY2VzJzpcbi8vICAgICAgICAgICAgICAgICBpZiAoIW1vZC5kYXRhLmRhdGEubGVuZ3RoKSB7XG4vLyAgICAgICAgICAgICAgICAgICAgIGlzRW1wdHkgPSB0cnVlO1xuLy8gICAgICAgICAgICAgICAgIH1cbi8vICAgICAgICAgICAgICAgICBicmVhaztcbi8vICAgICAgICAgICAgIGRlZmF1bHQ6XG4vLyAgICAgICAgICAgICAgICAgYnJlYWs7XG4vLyAgICAgICAgIH1cbi8vICAgICAgICAgcmV0dXJuICFpc0VtcHR5O1xuLy8gICAgIH0pO1xuLy8gICAgIHJldHVybiBtb2RNO1xuLy8gfTtcblxuZXhwb3J0IGRlZmF1bHQge1xuICAgIHBhcnNlUGFnZURhdGEocGFnZURhdGEpIHtcbiAgICAgICAgY29uc3QgbW9kcyA9IHBhZ2VEYXRhLm1hcCgobW9kKSA9PiB7XG4gICAgICAgICAgICBsZXQgY2ZnVGVtcCA9IHt9O1xuICAgICAgICAgICAgbGV0IHBhcmFtc1RlbXAgPSB7fTtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY2ZnVGVtcCA9IG1vZC5wcm9wcy5jZmcgfHwge307XG4gICAgICAgICAgICAgICAgcGFyYW1zVGVtcCA9IG1vZC5wYXJhbXMgPyBKU09OLnBhcnNlKG1vZC5wYXJhbXMpIDoge307XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2pzb24gZXJyb3JcXG4nLCBtb2QucHJvcHMuY2ZnLCAncGFyYW1zIGVycm9yXFxuJywgbW9kLnBhcmFtcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtb2QuY2ZnID0gY2ZnVGVtcDtcbiAgICAgICAgICAgIG1vZC5wYXJhbXMgPSBwYXJhbXNUZW1wO1xuXG4gICAgICAgICAgICBjb25zdCB7IG5hbWUsIGNmZywgY2ZnOiB7IHRpdGxlIH0gfSA9IG1vZDtcblxuICAgICAgICAgICAgY2ZnLnRpdGxlID0gdGl0bGUgfHwgbmFtZTtcblxuICAgICAgICAgICAgLy8gZGF0YSDkv67mlLlcbiAgICAgICAgICAgIC8vIGNvbnN0IG1vZERhdGEgPSBtb2QucHJvcHMuZGF0YVtuYW1lXSB8fCB7fTtcbiAgICAgICAgICAgIC8vIG1vZC5kYXRhID0gbW9kdWxlRGF0YVBhcnNlKG5hbWUsIG1vZERhdGEpO1xuXG4gICAgICAgICAgICAvLyBjZmcg5L+u5pS5XG4gICAgICAgICAgICAvLyDnibnlrprphY3nva7lpITnkIZcbiAgICAgICAgICAgIC8vIGltYWdlcyDmqKHlnZfnmoR1cmzlpITnkIZcbiAgICAgICAgICAgIG1vZHVsZUNmZ1BhcnNlKG5hbWUsIGNmZyk7XG5cbiAgICAgICAgICAgIHJldHVybiBtb2Q7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gbW9kcztcbiAgICB9LFxuICAgIHNob3cocGFnZURhdGEpIHtcbiAgICAgICAgY29uc3QgeyBtb2R1bGVzIH0gPSBwYWdlRGF0YTtcbiAgICAgICAgaWYgKCFtb2R1bGVzKSByZXR1cm4gW107XG4gICAgICAgIGNvbnN0IG1vZHMgPSBtb2R1bGVzLm1hcCgobW9kKSA9PiB7XG4gICAgICAgICAgICBsZXQgY2ZnVGVtcCA9IHt9O1xuICAgICAgICAgICAgbGV0IHBhcmFtc1RlbXAgPSB7fTtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY2ZnVGVtcCA9IG1vZC5jZmcgPyBKU09OLnBhcnNlKG1vZC5jZmcpIDoge307XG4gICAgICAgICAgICAgICAgcGFyYW1zVGVtcCA9IG1vZC5wYXJhbXMgPyBKU09OLnBhcnNlKG1vZC5wYXJhbXMpIDoge307XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2pzb24gZXJyb3JcXG4nLCBtb2QuY2ZnLCAncGFyYW1zIGVycm9yXFxuJywgbW9kLnBhcmFtcyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtb2QuY2ZnID0gY2ZnVGVtcDtcbiAgICAgICAgICAgIG1vZC5wYXJhbXMgPSBwYXJhbXNUZW1wO1xuXG4gICAgICAgICAgICBjb25zdCB7IG5hbWUsIGNmZywgY2ZnOiB7IHRpdGxlIH0gfSA9IG1vZDtcblxuICAgICAgICAgICAgY2ZnLnRpdGxlID0gdGl0bGUgfHwgbmFtZTtcblxuICAgICAgICAgICAgLy8gZGF0YSDkv67mlLlcbiAgICAgICAgICAgIGNvbnN0IG1vZERhdGEgPSBtb2QuZGF0YVtuYW1lXSB8fCB7fTtcbiAgICAgICAgICAgIG1vZC5kYXRhID0gbW9kdWxlRGF0YVBhcnNlKG5hbWUsIG1vZERhdGEpO1xuXG4gICAgICAgICAgICAvLyBjZmcg5L+u5pS5XG4gICAgICAgICAgICAvLyDnibnlrprphY3nva7lpITnkIZcbiAgICAgICAgICAgIC8vIGltYWdlcyDmqKHlnZfnmoR1cmzlpITnkIZcbiAgICAgICAgICAgIG1vZHVsZUNmZ1BhcnNlKG5hbWUsIGNmZyk7XG5cbiAgICAgICAgICAgIHJldHVybiBtb2Q7XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBt54mI5pys5LyY5Lqr5bCP56iL5bqPIOaVsOaNruS4uuepuueahOaXtuWAmeeJueauiuWkhOeQhuS4jeaYvuekulxuICAgICAgICAvLyBpZiAoZ2xvYmFsRGF0YS5tVmVyaXNvbikge1xuICAgICAgICAvLyAgICAgY29uc3QgbW9kc00gPSBlbXB0eUZpbHRlcihtb2RzKTtcbiAgICAgICAgLy8gICAgIHJldHVybiBtb2RzTTtcbiAgICAgICAgLy8gfVxuICAgICAgICByZXR1cm4gbW9kcztcbiAgICB9LFxuICAgIHNhdmUobW9kRGF0YSkge1xuICAgICAgICBjb25zdCBtb2RzID0gbW9kRGF0YS5tYXAoKG1vZCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyBuYW1lLCBjZmcgfSA9IG1vZDtcbiAgICAgICAgICAgIGlmICh+WydpbWFnZXMnLCAnaW1hZ2VTd2lwZXInLCAnYmFubmVyJ10uaW5kZXhPZihuYW1lKSkge1xuICAgICAgICAgICAgICAgIGNmZy5pbWFnZXMgPSBjZmcuaW1hZ2VzIHx8IFtdO1xuICAgICAgICAgICAgICAgIGNmZy5pbWFnZXMgPSBjZmcuaW1hZ2VzLmZpbHRlcihpbWcgPT4gaW1nLnNyYykubWFwKChpbWcpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGltZy5mdWxsUGF0aDtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGltZztcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBtb2Q7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBtb2RzO1xuICAgIH0sXG59O1xuXG4iXX0=