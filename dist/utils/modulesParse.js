'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.moduleCfgParse = exports.moduleDataParse = undefined;

var _index = require('./index.js');

var moduleDataParse = exports.moduleDataParse = function moduleDataParse(name) {
    var modData = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : { data: [] };

    if (~['services', 'serviceOther'].indexOf(name)) {
        if (modData.data && modData.data.length > 0) {
            modData.data.forEach(function (service) {
                service.img = (0, _index.picSrcDomain)() + service.img;
            });
        } else {
            modData = Object.assign({}, {
                page: 0,
                size: 0,
                total: 0,
                data: []
            }, modData);
        }
    }

    if (name === 'coupon') {
        if (!modData.data) {
            modData.data = [];
        } else {
            var _loop = function _loop(i) {
                var couponCondition = JSON.parse(modData.data[i].couponCondition);
                Object.keys(couponCondition).forEach(function (key) {
                    modData.data[i][key] = couponCondition[key];
                });
            };

            for (var i = 0; i < modData.data.length; i += 1) {
                _loop(i);
            }
        }
    }

    if (name === 'article') {
        if (modData.data.length > 0) {
            modData.data.forEach(function (art) {
                art.cover = (0, _index.picSrcDomain)() + art.cover;
            });
        }
    }

    if (name === 'order') {
        if (modData.data.length > 0) {
            modData.data.forEach(function (order) {
                order.pics = (0, _index.picSrcDomain)() + order.pics;
            });
        }
    }
    if (typeof modData.data === 'undefined' || modData.data === null) {
        Object.assign(modData, { data: [] });
    }
    return modData;
};

var moduleCfgParse = exports.moduleCfgParse = function moduleCfgParse(name, cfgObj) {
    var cfg = typeof cfgObj === 'string' ? JSON.parse(cfgObj) : cfgObj;

    if (~['images', 'imageSwiper', 'banner'].indexOf(name)) {
        cfg.images = cfg.images ? cfg.images : [];
        if (cfg.images.length > 0) {
            cfg.images = cfg.images.filter(function (img) {
                img.fullPath = (0, _index.picSrcDomain)() + img.src;
                return img.src;
            });
        }
        if (cfg.images.length === 0) {
            cfg.images.push({
                fullPath: '//pic8.58cdn.com.cn/bizmp/n_v285d6a16d725a446694db35df23c9db24.png'
            });
        }
    }
    if (name === 'images') {
        var imagesTheme = [{ theme: '1', showSize: '2', title: '一行1张显示' }, { theme: '2', showSize: '4', title: '一行2张显示' }, { theme: '3', showSize: '6', title: '一行3张显示' }, { theme: '4', showSize: '3', title: '1左2右显示' }, { theme: '5', showSize: '3', title: '1上2下显示' }, { theme: '6', showSize: '4', title: '1上3下显示' }, { theme: '7', showSize: '4', title: '一行4张显示' }, { theme: '8', showSize: '2', title: '双图' }];
        cfg.theme = cfg.theme ? cfg.theme.toString() : '1';
        cfg.showSize = imagesTheme[cfg.theme - 1].showSize || 4;
    }

    return cfg;
};

// const emptyFilter = (mods) => {
//     const modM = mods.filter((mod) => {
//         let isEmpty = false;
//         switch (mod.name) {
//             case 'video':
//                 if (!mod.data.length) {
//                     isEmpty = true;
//                 }
//                 break;
//             case 'services':
//                 if (!mod.data.data.length) {
//                     isEmpty = true;
//                 }
//                 break;
//             default:
//                 break;
//         }
//         return !isEmpty;
//     });
//     return modM;
// };

exports.default = {
    parsePageData: function parsePageData(pageData) {
        var mods = pageData.map(function (mod) {
            var cfgTemp = {};
            var paramsTemp = {};
            try {
                cfgTemp = mod.props.cfg || {};
                paramsTemp = mod.params ? JSON.parse(mod.params) : {};
            } catch (e) {
                console.log('json error\n', mod.props.cfg, 'params error\n', mod.params);
            }
            mod.cfg = cfgTemp;
            mod.params = paramsTemp;

            var name = mod.name,
                cfg = mod.cfg,
                title = mod.cfg.title;


            cfg.title = title || name;

            // data 修改
            // const modData = mod.props.data[name] || {};
            // mod.data = moduleDataParse(name, modData);

            // cfg 修改
            // 特定配置处理
            // images 模块的url处理
            moduleCfgParse(name, cfg);

            return mod;
        });
        return mods;
    },
    show: function show(pageData) {
        var modules = pageData.modules;

        if (!modules) return [];
        var mods = modules.map(function (mod) {
            var cfgTemp = {};
            var paramsTemp = {};
            try {
                cfgTemp = mod.cfg ? JSON.parse(mod.cfg) : {};
                paramsTemp = mod.params ? JSON.parse(mod.params) : {};
            } catch (e) {
                console.log('json error\n', mod.cfg, 'params error\n', mod.params);
            }
            mod.cfg = cfgTemp;
            mod.params = paramsTemp;

            var name = mod.name,
                cfg = mod.cfg,
                title = mod.cfg.title;


            cfg.title = title || name;

            // data 修改
            var modData = mod.data[name] || {};
            mod.data = moduleDataParse(name, modData);

            // cfg 修改
            // 特定配置处理
            // images 模块的url处理
            moduleCfgParse(name, cfg);

            return mod;
        });
        // m版本优享小程序 数据为空的时候特殊处理不显示
        // if (globalData.mVerison) {
        //     const modsM = emptyFilter(mods);
        //     return modsM;
        // }
        return mods;
    },
    save: function save(modData) {
        var mods = modData.map(function (mod) {
            var name = mod.name,
                cfg = mod.cfg;

            if (~['images', 'imageSwiper', 'banner'].indexOf(name)) {
                cfg.images = cfg.images || [];
                cfg.images = cfg.images.filter(function (img) {
                    return img.src;
                }).map(function (img) {
                    delete img.fullPath;
                    return img;
                });
            }
            return mod;
        });

        return mods;
    }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXNQYXJzZS5qcyJdLCJuYW1lcyI6WyJtb2R1bGVEYXRhUGFyc2UiLCJuYW1lIiwibW9kRGF0YSIsImRhdGEiLCJpbmRleE9mIiwibGVuZ3RoIiwiZm9yRWFjaCIsInNlcnZpY2UiLCJpbWciLCJPYmplY3QiLCJhc3NpZ24iLCJwYWdlIiwic2l6ZSIsInRvdGFsIiwiaSIsImNvdXBvbkNvbmRpdGlvbiIsIkpTT04iLCJwYXJzZSIsImtleXMiLCJrZXkiLCJhcnQiLCJjb3ZlciIsIm9yZGVyIiwicGljcyIsIm1vZHVsZUNmZ1BhcnNlIiwiY2ZnT2JqIiwiY2ZnIiwiaW1hZ2VzIiwiZmlsdGVyIiwiZnVsbFBhdGgiLCJzcmMiLCJwdXNoIiwiaW1hZ2VzVGhlbWUiLCJ0aGVtZSIsInNob3dTaXplIiwidGl0bGUiLCJ0b1N0cmluZyIsInBhcnNlUGFnZURhdGEiLCJwYWdlRGF0YSIsIm1vZHMiLCJtYXAiLCJtb2QiLCJjZmdUZW1wIiwicGFyYW1zVGVtcCIsInByb3BzIiwicGFyYW1zIiwiZSIsImNvbnNvbGUiLCJsb2ciLCJzaG93IiwibW9kdWxlcyIsInNhdmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFFTyxJQUFNQSw0Q0FBa0IsU0FBbEJBLGVBQWtCLENBQUNDLElBQUQsRUFBa0M7QUFBQSxRQUEzQkMsT0FBMkIsdUVBQWpCLEVBQUVDLE1BQU0sRUFBUixFQUFpQjs7QUFDN0QsUUFBSSxDQUFDLENBQUMsVUFBRCxFQUFhLGNBQWIsRUFBNkJDLE9BQTdCLENBQXFDSCxJQUFyQyxDQUFMLEVBQWlEO0FBQzdDLFlBQUlDLFFBQVFDLElBQVIsSUFBZ0JELFFBQVFDLElBQVIsQ0FBYUUsTUFBYixHQUFzQixDQUExQyxFQUE2QztBQUN6Q0gsb0JBQVFDLElBQVIsQ0FBYUcsT0FBYixDQUFxQixVQUFDQyxPQUFELEVBQWE7QUFDOUJBLHdCQUFRQyxHQUFSLEdBQWMsNkJBQWlCRCxRQUFRQyxHQUF2QztBQUNILGFBRkQ7QUFHSCxTQUpELE1BSU87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QUFTO0FBQUEsZ0JBQ3RCeEMsSUFEc0IsR0FDUndDLEdBRFEsQ0FDdEJ4QyxJQURzQjtBQUFBLGdCQUNoQnlCLEdBRGdCLEdBQ1JlLEdBRFEsQ0FDaEJmLEdBRGdCOztBQUU5QixnQkFBSSxDQUFDLENBQUMsUUFBRCxFQUFXLGFBQVgsRUFBMEIsUUFBMUIsRUFBb0N0QixPQUFwQyxDQUE0Q0gsSUFBNUMsQ0FBTCxFQUF3RDtBQUNwRHlCLG9CQUFJQyxNQUFKLEdBQWFELElBQUlDLE1BQUosSUFBYyxFQUEzQjtBQUNBRCxvQkFBSUMsTUFBSixHQUFhRCxJQUFJQyxNQUFKLENBQVdDLE1BQVgsQ0FBa0I7QUFBQSwyQkFBT3BCLElBQUlzQixHQUFYO0FBQUEsaUJBQWxCLEVBQWtDVSxHQUFsQyxDQUFzQyxVQUFDaEMsR0FBRCxFQUFTO0FBQ3hELDJCQUFPQSxJQUFJcUIsUUFBWDtBQUNBLDJCQUFPckIsR0FBUDtBQUNILGlCQUhZLENBQWI7QUFJSDtBQUNELG1CQUFPaUMsR0FBUDtBQUNILFNBVlksQ0FBYjs7QUFZQSxlQUFPRixJQUFQO0FBQ0g7QUFsRlUsQyIsImZpbGUiOiJtb2R1bGVzUGFyc2UuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBwaWNTcmNEb21haW4gfSBmcm9tICcuL2luZGV4JztcclxuXHJcbmV4cG9ydCBjb25zdCBtb2R1bGVEYXRhUGFyc2UgPSAobmFtZSwgbW9kRGF0YSA9IHsgZGF0YTogW10gfSkgPT4ge1xyXG4gICAgaWYgKH5bJ3NlcnZpY2VzJywgJ3NlcnZpY2VPdGhlciddLmluZGV4T2YobmFtZSkpIHtcclxuICAgICAgICBpZiAobW9kRGF0YS5kYXRhICYmIG1vZERhdGEuZGF0YS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIG1vZERhdGEuZGF0YS5mb3JFYWNoKChzZXJ2aWNlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBzZXJ2aWNlLmltZyA9IHBpY1NyY0RvbWFpbigpICsgc2VydmljZS5pbWc7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIG1vZERhdGEgPSBPYmplY3QuYXNzaWduKHt9LCB7XHJcbiAgICAgICAgICAgICAgICBwYWdlOiAwLFxyXG4gICAgICAgICAgICAgICAgc2l6ZTogMCxcclxuICAgICAgICAgICAgICAgIHRvdGFsOiAwLFxyXG4gICAgICAgICAgICAgICAgZGF0YTogW10sXHJcbiAgICAgICAgICAgIH0sIG1vZERhdGEpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAobmFtZSA9PT0gJ2NvdXBvbicpIHtcclxuICAgICAgICBpZiAoIW1vZERhdGEuZGF0YSkge1xyXG4gICAgICAgICAgICBtb2REYXRhLmRhdGEgPSBbXTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1vZERhdGEuZGF0YS5sZW5ndGg7IGkgKz0gMSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY291cG9uQ29uZGl0aW9uID0gSlNPTi5wYXJzZShtb2REYXRhLmRhdGFbaV0uY291cG9uQ29uZGl0aW9uKTtcclxuICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKGNvdXBvbkNvbmRpdGlvbikuZm9yRWFjaCgoa2V5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbW9kRGF0YS5kYXRhW2ldW2tleV0gPSBjb3Vwb25Db25kaXRpb25ba2V5XTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChuYW1lID09PSAnYXJ0aWNsZScpIHtcclxuICAgICAgICBpZiAobW9kRGF0YS5kYXRhLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgbW9kRGF0YS5kYXRhLmZvckVhY2goKGFydCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgYXJ0LmNvdmVyID0gcGljU3JjRG9tYWluKCkgKyBhcnQuY292ZXI7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAobmFtZSA9PT0gJ29yZGVyJykge1xyXG4gICAgICAgIGlmIChtb2REYXRhLmRhdGEubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBtb2REYXRhLmRhdGEuZm9yRWFjaCgob3JkZXIpID0+IHtcclxuICAgICAgICAgICAgICAgIG9yZGVyLnBpY3MgPSBwaWNTcmNEb21haW4oKSArIG9yZGVyLnBpY3M7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGlmICh0eXBlb2YgKG1vZERhdGEuZGF0YSkgPT09ICd1bmRlZmluZWQnIHx8IG1vZERhdGEuZGF0YSA9PT0gbnVsbCkge1xyXG4gICAgICAgIE9iamVjdC5hc3NpZ24obW9kRGF0YSwgeyBkYXRhOiBbXSB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiBtb2REYXRhO1xyXG59O1xyXG5cclxuXHJcbmV4cG9ydCBjb25zdCBtb2R1bGVDZmdQYXJzZSA9IChuYW1lLCBjZmdPYmopID0+IHtcclxuICAgIGNvbnN0IGNmZyA9IHR5cGVvZiBjZmdPYmogPT09ICdzdHJpbmcnID8gSlNPTi5wYXJzZShjZmdPYmopIDogY2ZnT2JqO1xyXG5cclxuICAgIGlmICh+WydpbWFnZXMnLCAnaW1hZ2VTd2lwZXInLCAnYmFubmVyJ10uaW5kZXhPZihuYW1lKSkge1xyXG4gICAgICAgIGNmZy5pbWFnZXMgPSBjZmcuaW1hZ2VzID8gY2ZnLmltYWdlcyA6IFtdO1xyXG4gICAgICAgIGlmIChjZmcuaW1hZ2VzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgY2ZnLmltYWdlcyA9IGNmZy5pbWFnZXMuZmlsdGVyKChpbWcpID0+IHtcclxuICAgICAgICAgICAgICAgIGltZy5mdWxsUGF0aCA9IHBpY1NyY0RvbWFpbigpICsgaW1nLnNyYztcclxuICAgICAgICAgICAgICAgIHJldHVybiBpbWcuc3JjO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNmZy5pbWFnZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIGNmZy5pbWFnZXMucHVzaCh7XHJcbiAgICAgICAgICAgICAgICBmdWxsUGF0aDogJy8vcGljOC41OGNkbi5jb20uY24vYml6bXAvbl92Mjg1ZDZhMTZkNzI1YTQ0NjY5NGRiMzVkZjIzYzlkYjI0LnBuZycsXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGlmIChuYW1lID09PSAnaW1hZ2VzJykge1xyXG4gICAgICAgIGNvbnN0IGltYWdlc1RoZW1lID0gW1xyXG4gICAgICAgICAgICB7IHRoZW1lOiAnMScsIHNob3dTaXplOiAnMicsIHRpdGxlOiAn5LiA6KGMMeW8oOaYvuekuicgfSxcclxuICAgICAgICAgICAgeyB0aGVtZTogJzInLCBzaG93U2l6ZTogJzQnLCB0aXRsZTogJ+S4gOihjDLlvKDmmL7npLonIH0sXHJcbiAgICAgICAgICAgIHsgdGhlbWU6ICczJywgc2hvd1NpemU6ICc2JywgdGl0bGU6ICfkuIDooYwz5byg5pi+56S6JyB9LFxyXG4gICAgICAgICAgICB7IHRoZW1lOiAnNCcsIHNob3dTaXplOiAnMycsIHRpdGxlOiAnMeW3pjLlj7PmmL7npLonIH0sXHJcbiAgICAgICAgICAgIHsgdGhlbWU6ICc1Jywgc2hvd1NpemU6ICczJywgdGl0bGU6ICcx5LiKMuS4i+aYvuekuicgfSxcclxuICAgICAgICAgICAgeyB0aGVtZTogJzYnLCBzaG93U2l6ZTogJzQnLCB0aXRsZTogJzHkuIoz5LiL5pi+56S6JyB9LFxyXG4gICAgICAgICAgICB7IHRoZW1lOiAnNycsIHNob3dTaXplOiAnNCcsIHRpdGxlOiAn5LiA6KGMNOW8oOaYvuekuicgfSxcclxuICAgICAgICAgICAgeyB0aGVtZTogJzgnLCBzaG93U2l6ZTogJzInLCB0aXRsZTogJ+WPjOWbvicgfSxcclxuICAgICAgICBdO1xyXG4gICAgICAgIGNmZy50aGVtZSA9IGNmZy50aGVtZSA/IGNmZy50aGVtZS50b1N0cmluZygpIDogJzEnO1xyXG4gICAgICAgIGNmZy5zaG93U2l6ZSA9IGltYWdlc1RoZW1lW2NmZy50aGVtZSAtIDFdLnNob3dTaXplIHx8IDQ7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGNmZztcclxufTtcclxuXHJcbi8vIGNvbnN0IGVtcHR5RmlsdGVyID0gKG1vZHMpID0+IHtcclxuLy8gICAgIGNvbnN0IG1vZE0gPSBtb2RzLmZpbHRlcigobW9kKSA9PiB7XHJcbi8vICAgICAgICAgbGV0IGlzRW1wdHkgPSBmYWxzZTtcclxuLy8gICAgICAgICBzd2l0Y2ggKG1vZC5uYW1lKSB7XHJcbi8vICAgICAgICAgICAgIGNhc2UgJ3ZpZGVvJzpcclxuLy8gICAgICAgICAgICAgICAgIGlmICghbW9kLmRhdGEubGVuZ3RoKSB7XHJcbi8vICAgICAgICAgICAgICAgICAgICAgaXNFbXB0eSA9IHRydWU7XHJcbi8vICAgICAgICAgICAgICAgICB9XHJcbi8vICAgICAgICAgICAgICAgICBicmVhaztcclxuLy8gICAgICAgICAgICAgY2FzZSAnc2VydmljZXMnOlxyXG4vLyAgICAgICAgICAgICAgICAgaWYgKCFtb2QuZGF0YS5kYXRhLmxlbmd0aCkge1xyXG4vLyAgICAgICAgICAgICAgICAgICAgIGlzRW1wdHkgPSB0cnVlO1xyXG4vLyAgICAgICAgICAgICAgICAgfVxyXG4vLyAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbi8vICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbi8vICAgICAgICAgICAgICAgICBicmVhaztcclxuLy8gICAgICAgICB9XHJcbi8vICAgICAgICAgcmV0dXJuICFpc0VtcHR5O1xyXG4vLyAgICAgfSk7XHJcbi8vICAgICByZXR1cm4gbW9kTTtcclxuLy8gfTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IHtcclxuICAgIHBhcnNlUGFnZURhdGEocGFnZURhdGEpIHtcclxuICAgICAgICBjb25zdCBtb2RzID0gcGFnZURhdGEubWFwKChtb2QpID0+IHtcclxuICAgICAgICAgICAgbGV0IGNmZ1RlbXAgPSB7fTtcclxuICAgICAgICAgICAgbGV0IHBhcmFtc1RlbXAgPSB7fTtcclxuICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIGNmZ1RlbXAgPSBtb2QucHJvcHMuY2ZnIHx8IHt9O1xyXG4gICAgICAgICAgICAgICAgcGFyYW1zVGVtcCA9IG1vZC5wYXJhbXMgPyBKU09OLnBhcnNlKG1vZC5wYXJhbXMpIDoge307XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdqc29uIGVycm9yXFxuJywgbW9kLnByb3BzLmNmZywgJ3BhcmFtcyBlcnJvclxcbicsIG1vZC5wYXJhbXMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIG1vZC5jZmcgPSBjZmdUZW1wO1xyXG4gICAgICAgICAgICBtb2QucGFyYW1zID0gcGFyYW1zVGVtcDtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHsgbmFtZSwgY2ZnLCBjZmc6IHsgdGl0bGUgfSB9ID0gbW9kO1xyXG5cclxuICAgICAgICAgICAgY2ZnLnRpdGxlID0gdGl0bGUgfHwgbmFtZTtcclxuXHJcbiAgICAgICAgICAgIC8vIGRhdGEg5L+u5pS5XHJcbiAgICAgICAgICAgIC8vIGNvbnN0IG1vZERhdGEgPSBtb2QucHJvcHMuZGF0YVtuYW1lXSB8fCB7fTtcclxuICAgICAgICAgICAgLy8gbW9kLmRhdGEgPSBtb2R1bGVEYXRhUGFyc2UobmFtZSwgbW9kRGF0YSk7XHJcblxyXG4gICAgICAgICAgICAvLyBjZmcg5L+u5pS5XHJcbiAgICAgICAgICAgIC8vIOeJueWumumFjee9ruWkhOeQhlxyXG4gICAgICAgICAgICAvLyBpbWFnZXMg5qih5Z2X55qEdXJs5aSE55CGXHJcbiAgICAgICAgICAgIG1vZHVsZUNmZ1BhcnNlKG5hbWUsIGNmZyk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gbW9kO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBtb2RzO1xyXG4gICAgfSxcclxuICAgIHNob3cocGFnZURhdGEpIHtcclxuICAgICAgICBjb25zdCB7IG1vZHVsZXMgfSA9IHBhZ2VEYXRhO1xyXG4gICAgICAgIGlmICghbW9kdWxlcykgcmV0dXJuIFtdO1xyXG4gICAgICAgIGNvbnN0IG1vZHMgPSBtb2R1bGVzLm1hcCgobW9kKSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBjZmdUZW1wID0ge307XHJcbiAgICAgICAgICAgIGxldCBwYXJhbXNUZW1wID0ge307XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBjZmdUZW1wID0gbW9kLmNmZyA/IEpTT04ucGFyc2UobW9kLmNmZykgOiB7fTtcclxuICAgICAgICAgICAgICAgIHBhcmFtc1RlbXAgPSBtb2QucGFyYW1zID8gSlNPTi5wYXJzZShtb2QucGFyYW1zKSA6IHt9O1xyXG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnanNvbiBlcnJvclxcbicsIG1vZC5jZmcsICdwYXJhbXMgZXJyb3JcXG4nLCBtb2QucGFyYW1zKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBtb2QuY2ZnID0gY2ZnVGVtcDtcclxuICAgICAgICAgICAgbW9kLnBhcmFtcyA9IHBhcmFtc1RlbXA7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB7IG5hbWUsIGNmZywgY2ZnOiB7IHRpdGxlIH0gfSA9IG1vZDtcclxuXHJcbiAgICAgICAgICAgIGNmZy50aXRsZSA9IHRpdGxlIHx8IG5hbWU7XHJcblxyXG4gICAgICAgICAgICAvLyBkYXRhIOS/ruaUuVxyXG4gICAgICAgICAgICBjb25zdCBtb2REYXRhID0gbW9kLmRhdGFbbmFtZV0gfHwge307XHJcbiAgICAgICAgICAgIG1vZC5kYXRhID0gbW9kdWxlRGF0YVBhcnNlKG5hbWUsIG1vZERhdGEpO1xyXG5cclxuICAgICAgICAgICAgLy8gY2ZnIOS/ruaUuVxyXG4gICAgICAgICAgICAvLyDnibnlrprphY3nva7lpITnkIZcclxuICAgICAgICAgICAgLy8gaW1hZ2VzIOaooeWdl+eahHVybOWkhOeQhlxyXG4gICAgICAgICAgICBtb2R1bGVDZmdQYXJzZShuYW1lLCBjZmcpO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIG1vZDtcclxuICAgICAgICB9KTtcclxuICAgICAgICAvLyBt54mI5pys5LyY5Lqr5bCP56iL5bqPIOaVsOaNruS4uuepuueahOaXtuWAmeeJueauiuWkhOeQhuS4jeaYvuekulxyXG4gICAgICAgIC8vIGlmIChnbG9iYWxEYXRhLm1WZXJpc29uKSB7XHJcbiAgICAgICAgLy8gICAgIGNvbnN0IG1vZHNNID0gZW1wdHlGaWx0ZXIobW9kcyk7XHJcbiAgICAgICAgLy8gICAgIHJldHVybiBtb2RzTTtcclxuICAgICAgICAvLyB9XHJcbiAgICAgICAgcmV0dXJuIG1vZHM7XHJcbiAgICB9LFxyXG4gICAgc2F2ZShtb2REYXRhKSB7XHJcbiAgICAgICAgY29uc3QgbW9kcyA9IG1vZERhdGEubWFwKChtb2QpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgeyBuYW1lLCBjZmcgfSA9IG1vZDtcclxuICAgICAgICAgICAgaWYgKH5bJ2ltYWdlcycsICdpbWFnZVN3aXBlcicsICdiYW5uZXInXS5pbmRleE9mKG5hbWUpKSB7XHJcbiAgICAgICAgICAgICAgICBjZmcuaW1hZ2VzID0gY2ZnLmltYWdlcyB8fCBbXTtcclxuICAgICAgICAgICAgICAgIGNmZy5pbWFnZXMgPSBjZmcuaW1hZ2VzLmZpbHRlcihpbWcgPT4gaW1nLnNyYykubWFwKChpbWcpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBkZWxldGUgaW1nLmZ1bGxQYXRoO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpbWc7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gbW9kO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gbW9kcztcclxuICAgIH0sXHJcbn07XHJcblxyXG4iXX0=